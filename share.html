<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Share a Recipe</title>
  <style>
    :root{
      --primary:#e1b6b6;
      --accent:#1a2f23;
      --accent2:#8e7158;
      --paper:#ffffff;
      --ink:#2A2422;
      --shadow:0 14px 35px rgba(0,0,0,.10);
      --radius:18px;
      --sans:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      --serif:Georgia, "Times New Roman", serif;
    }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--ink);
      background:
        radial-gradient(900px 520px at 12% 10%, rgba(225,182,182,.55), transparent 58%),
        radial-gradient(900px 520px at 88% 12%, rgba(26,47,35,.10), transparent 58%),
        linear-gradient(180deg, #fff, #fbf7f5);
    }
    .wrap{ max-width:1080px; margin:0 auto; padding:22px 16px 60px; }
    .card{
      background:var(--paper);
      border-radius:26px;
      box-shadow:var(--shadow);
      border:1px solid rgba(142,113,88,.22);
      overflow:hidden;
    }
    header{
      padding:22px 18px 18px;
      background: linear-gradient(120deg, rgba(225,182,182,.85), rgba(255,255,255,.92) 55%, rgba(26,47,35,.06));
      border-bottom:1px solid rgba(142,113,88,.16);
    }
    h1{ margin:0; font-family:var(--serif); font-size:clamp(22px, 3.6vw, 32px); }
    p{ margin:10px 0 0; color:rgba(42,36,34,.78); font-size:14px; }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; padding:16px 18px 18px; }
    @media (max-width: 920px){ .grid{ grid-template-columns:1fr; } }

    .box{
      border:1px solid rgba(142,113,88,.20);
      border-radius:18px;
      background:rgba(255,255,255,.92);
      box-shadow: 0 10px 24px rgba(0,0,0,.05);
      padding:14px;
    }
    .box h2{ margin:0 0 10px; font-family:var(--serif); font-size:16px; }
    label{ display:block; font-size:12px; color:rgba(42,36,34,.72); margin:10px 0 6px; font-weight:500; }
    label .required{ color:#d64545; }
    label .hint{ font-weight:400; font-size:11px; color:rgba(42,36,34,.58); }
    
    input[type="text"], input[type="file"], textarea, select{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(142,113,88,.22);
      padding:10px 11px;
      font-size:14px;
      outline:none;
      font-family:var(--sans);
    }
    select{
      background:white;
      cursor:pointer;
    }
    textarea{ min-height:120px; resize:vertical; }
    textarea.short{ min-height:70px; }

    .actions{ display:flex; flex-wrap:wrap; gap:10px; margin-top:12px; }
    button{
      border-radius:14px;
      border:1px solid rgba(142,113,88,.30);
      padding:10px 12px;
      font-size:13px;
      cursor:pointer;
      background: linear-gradient(180deg, rgba(225,182,182,.55), rgba(255,255,255,.95));
      color:var(--ink);
      transition: transform .08s ease;
    }
    button:hover{ transform: translateY(-1px); }
    button:disabled{
      opacity:0.5;
      cursor:not-allowed;
      transform:none !important;
    }
    button.primary{
      background: linear-gradient(180deg, rgba(26,47,35,.96), rgba(26,47,35,.90));
      border-color: rgba(26,47,35,.55);
      color:#fff;
    }
    button.secondary{
      background: linear-gradient(180deg, rgba(142,113,88,.22), rgba(255,255,255,.95));
    }
    .muted{ font-size:12px; color:rgba(42,36,34,.72); margin-top:10px; line-height:1.4; }
    .status{
      margin-top:10px;
      font-size:12px;
      color:rgba(42,36,34,.78);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .bar{
      flex:1;
      height:8px;
      border-radius:999px;
      background:rgba(142,113,88,.14);
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(26,47,35,.80), rgba(142,113,88,.70));
      transition: width .15s ease;
    }
    .preview{
      display:grid;
      gap:10px;
    }
    .imgWrap{
      border-radius:18px;
      border:1px solid rgba(142,113,88,.20);
      background:rgba(251,247,245,.8);
      overflow:hidden;
    }
    img{ width:100%; height:auto; display:block; }
    .smallNote{
      font-size:12px;
      color:rgba(42,36,34,.72);
      line-height:1.4;
    }
    .infoBox{
      background:rgba(225,182,182,.12);
      border:1px solid rgba(142,113,88,.18);
      border-radius:14px;
      padding:12px;
      margin-top:12px;
      font-size:12px;
      line-height:1.5;
    }
    .infoBox strong{ color:var(--accent); }
  </style>

  <!-- Tesseract.js (browser OCR) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <header>
        <h1>Share a Recipe</h1>
        <p>Upload a recipe photo, extract text with OCR, fill in the details, and submit to the Family Cookbook.</p>
      </header>

      <div class="grid">

        <!-- LEFT: Upload + OCR -->
        <div class="box">
          <h2>1) Upload Recipe Photo (Optional)</h2>

          <label>Recipe photo (typed cards work best)</label>
          <input id="photoInput" type="file" accept="image/*" />

          <div class="preview" style="margin-top:12px;">
            <div class="imgWrap" id="imgWrap" style="display:none;">
              <img id="previewImg" alt="Recipe preview"/>
            </div>

            <div class="actions">
              <button type="button" class="secondary" id="btnExtract" disabled>Extract Text (OCR)</button>
              <button type="button" id="btnClear" disabled>Clear Photo</button>
            </div>

            <div class="status" id="status" style="display:none;">
              <span id="statusText">Preparing OCR…</span>
              <div class="bar"><div id="barFill"></div></div>
            </div>

            <div class="smallNote">
              <strong>Tip:</strong> Crop tight around the recipe text before uploading for best OCR results. You can also skip the photo and type directly into the form.
            </div>
          </div>
        </div>

        <!-- RIGHT: Recipe Details -->
        <div class="box">
          <h2>2) Recipe Details</h2>

          <label>Recipe Title <span class="required">*</span></label>
          <input id="titleBox" type="text" placeholder="e.g., Grandma's Peach Cobbler" required />

          <label>Category <span class="required">*</span></label>
          <select id="categoryBox" required>
            <option value="">-- Select Category --</option>
            <option value="Breakfast">Breakfast</option>
            <option value="Main Course">Main Course</option>
            <option value="Side Dish">Side Dish</option>
            <option value="Dessert">Dessert</option>
            <option value="Appetizer">Appetizer</option>
            <option value="Salad">Salad</option>
            <option value="Soup">Soup</option>
            <option value="Beverage">Beverage</option>
            <option value="Preserved">Preserved</option>
            <option value="Sauce/Condiment">Sauce/Condiment</option>
            <option value="Other">Other</option>
          </select>

          <label>Tags <span class="hint">(separate with | pipe character)</span></label>
          <input id="tagsBox" type="text" placeholder="e.g., Quick|Easy|Family Favorite" />

          <label>Cooking Time/Temperature</label>
          <input id="timeBox" type="text" placeholder="e.g., Bake 350°F, 30 min" />
        </div>

      </div>

      <!-- Full Width Sections -->
      <div style="padding:0 18px 18px;">
        
        <div class="box" style="margin-bottom:14px;">
          <h2>3) Ingredients <span class="required">*</span></h2>
          <div class="infoBox">
            <strong>Format:</strong> Put each ingredient on a separate line, OR separate with the <strong>|</strong> (pipe) character.
            <br><strong>Example:</strong> 2 cups flour|1 cup sugar|3 eggs
          </div>
          <textarea id="ingredientsBox" placeholder="2 cups flour|1 cup sugar|3 eggs|1 tsp vanilla" required></textarea>
        </div>

        <div class="box" style="margin-bottom:14px;">
          <h2>4) Directions <span class="required">*</span></h2>
          <div class="infoBox">
            <strong>Format:</strong> Put each step on a separate line, OR separate with the <strong>|</strong> (pipe) character.
            <br><strong>Example:</strong> Preheat oven to 350°F|Mix dry ingredients|Add wet ingredients|Bake 30 minutes
          </div>
          <textarea id="stepsBox" placeholder="Preheat oven to 350°F|Mix ingredients|Pour into pan|Bake 30 minutes" required></textarea>
        </div>

        <div class="box">
          <h2>5) Notes (Optional)</h2>
          <label>Additional notes, source, or tips</label>
          <textarea id="notesBox" class="short" placeholder="Example: 'From Aunt Linda's card, 1998' or 'Serve warm with ice cream'"></textarea>

          <div class="actions">
            <button type="button" class="primary" id="btnSubmit">Submit to Cookbook</button>
            <button type="button" id="btnReset">Reset Form</button>
          </div>
          
          <div class="muted">
            Required fields are marked with <span style="color:#d64545;">*</span>. Once you submit, the recipe will be added to the family cookbook within a few minutes!
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    // === CONFIG ===
    const FORM_BASE = "https://docs.google.com/forms/d/e/1FAIpQLSdhYWTAHVid0Ec4kLCKRh2ZrHegYB8VjefEqBCLPx3VRFfEGw/formRecipes";
    const UPLOAD_API = "/api/upload"; // Vercel function endpoint
    
    // Entry IDs from your Google Form
    const ENTRY_TITLE = "entry.1770944788";
    const ENTRY_CATEGORY = "entry.1070788598";
    const ENTRY_TAGS = "entry.1873529935";
    const ENTRY_TIME = "entry.1741960360";
    const ENTRY_ING = "entry.991892970";
    const ENTRY_STEPS = "entry.1029695301";
    const ENTRY_NOTES = "entry.449103203";
    const ENTRY_PHOTO = "entry.940284355";

    // Form elements
    const photoInput = document.getElementById("photoInput");
    const btnExtract = document.getElementById("btnExtract");
    const btnClear = document.getElementById("btnClear");
    const btnSubmit = document.getElementById("btnSubmit");
    const btnReset = document.getElementById("btnReset");

    const imgWrap = document.getElementById("imgWrap");
    const previewImg = document.getElementById("previewImg");

    const status = document.getElementById("status");
    const statusText = document.getElementById("statusText");
    const barFill = document.getElementById("barFill");

    const titleBox = document.getElementById("titleBox");
    const categoryBox = document.getElementById("categoryBox");
    const tagsBox = document.getElementById("tagsBox");
    const timeBox = document.getElementById("timeBox");
    const ingredientsBox = document.getElementById("ingredientsBox");
    const stepsBox = document.getElementById("stepsBox");
    const notesBox = document.getElementById("notesBox");

    let fileBlob = null;
    let uploadedPhotoUrl = null;

    function setProgress(pct, msg){
      status.style.display = "flex";
      statusText.textContent = msg || "Working…";
      barFill.style.width = `${Math.max(0, Math.min(100, pct))}%`;
    }

    function resetAll(){
      fileBlob = null;
      uploadedPhotoUrl = null;
      photoInput.value = "";
      imgWrap.style.display = "none";
      previewImg.src = "";
      btnExtract.disabled = true;
      btnClear.disabled = true;
      status.style.display = "none";
      barFill.style.width = "0%";
      
      titleBox.value = "";
      categoryBox.value = "";
      tagsBox.value = "";
      timeBox.value = "";
      ingredientsBox.value = "";
      stepsBox.value = "";
      notesBox.value = "";
    }

    photoInput.addEventListener("change", () => {
      const file = photoInput.files && photoInput.files[0];
      if(!file) return;

      fileBlob = file;

      const url = URL.createObjectURL(file);
      previewImg.src = url;
      imgWrap.style.display = "block";

      btnExtract.disabled = false;
      btnClear.disabled = false;
    });

    btnClear.addEventListener("click", () => {
      fileBlob = null;
      uploadedPhotoUrl = null;
      photoInput.value = "";
      imgWrap.style.display = "none";
      previewImg.src = "";
      btnExtract.disabled = true;
      btnClear.disabled = true;
      status.style.display = "none";
      barFill.style.width = "0%";
    });

    btnReset.addEventListener("click", () => {
      if(confirm("Are you sure you want to clear all fields?")) {
        resetAll();
      }
    });

    // Normalize line breaks to pipe characters for Google Sheets
    function normalizeToPipes(text) {
      if (!text) return "";
      // Replace newlines with pipes, then clean up multiple pipes
      return text
        .split(/\n/)
        .map(line => line.trim())
        .filter(line => line.length > 0)
        .join("|");
    }

    // Simple heuristic splitter for typed cards
    function splitIntoIngredientsAndSteps(text){
      const clean = (text || "").replace(/\r/g, "").trim();

      // Try common headings
      const lower = clean.toLowerCase();
      const idxIng = lower.indexOf("ingredients");
      const idxSteps = Math.max(
        lower.indexOf("instructions"),
        lower.indexOf("directions"),
        lower.indexOf("steps"),
        lower.indexOf("method")
      );

      if(idxIng !== -1 && idxSteps !== -1 && idxSteps > idxIng){
        const ingBlock = clean.slice(idxIng, idxSteps).replace(/ingredients\s*:?\s*/i, "").trim();
        const stepBlock = clean.slice(idxSteps).replace(/(instructions|directions|steps|method)\s*:?\s*/i, "").trim();
        return { ingredients: ingBlock, steps: stepBlock };
      }

      // If no headings, fall back: first ~40% lines as ingredients
      const lines = clean.split("\n").map(l => l.trim()).filter(Boolean);
      const cut = Math.max(3, Math.floor(lines.length * 0.4));
      return {
        ingredients: lines.slice(0, cut).join("\n"),
        steps: lines.slice(cut).join("\n")
      };
    }

    btnExtract.addEventListener("click", async () => {
      if(!fileBlob) return;

      try{
        btnExtract.disabled = true;
        setProgress(2, "Starting OCR…");

        // Run OCR in browser
        const { data } = await Tesseract.recognize(
          fileBlob,
          "eng",
          {
            logger: m => {
              if(m.status === "recognizing text" && m.progress != null){
                setProgress(10 + Math.round(m.progress * 90), `Reading text… ${Math.round(m.progress * 100)}%`);
              } else if (m.status){
                setProgress(8, m.status);
              }
            }
          }
        );

        const raw = (data && data.text) ? data.text : "";
        const { ingredients, steps } = splitIntoIngredientsAndSteps(raw);

        ingredientsBox.value = ingredients || "";
        stepsBox.value = steps || "";

        setProgress(100, "Done! Review and edit the text, then fill in the other fields.");
        setTimeout(() => { status.style.display = "none"; }, 1500);
      } catch (err){
        console.error(err);
        setProgress(100, "OCR failed. You can still type the recipe manually.");
        setTimeout(() => { status.style.display = "none"; }, 2000);
      } finally {
        btnExtract.disabled = false;
      }
    });

    // Upload photo to Vercel Blob Storage
    async function uploadPhoto(){
      if(!fileBlob) return null;

      try {
        setProgress(10, "Uploading photo to storage…");
        
        const formData = new FormData();
        formData.append("file", fileBlob);

        const response = await fetch(UPLOAD_API, {
          method: "POST",
          body: formData
        });

        if(!response.ok) {
          throw new Error("Upload failed");
        }

        const data = await response.json();
        setProgress(50, "Photo uploaded successfully!");
        
        return data.url;
      } catch(err) {
        console.error("Photo upload error:", err);
        alert("Photo upload failed. The recipe will be submitted without a photo.");
        return null;
      }
    }

    btnSubmit.addEventListener("click", async () => {
      // Validate required fields
      if (!titleBox.value.trim()) {
        alert("Please enter a recipe title.");
        titleBox.focus();
        return;
      }
      if (!categoryBox.value) {
        alert("Please select a category.");
        categoryBox.focus();
        return;
      }
      if (!ingredientsBox.value.trim()) {
        alert("Please enter ingredients.");
        ingredientsBox.focus();
        return;
      }
      if (!stepsBox.value.trim()) {
        alert("Please enter cooking directions.");
        stepsBox.focus();
        return;
      }

      // Disable submit button to prevent double-submission
      btnSubmit.disabled = true;

      try {
        // Upload photo if present
        if(fileBlob) {
          uploadedPhotoUrl = await uploadPhoto();
        }

        setProgress(75, "Preparing form submission…");

        // Create form data for direct submission
        const formData = new FormData();
        
        formData.append(ENTRY_TITLE, titleBox.value.trim());
        formData.append(ENTRY_CATEGORY, categoryBox.value);
        formData.append(ENTRY_TAGS, tagsBox.value.trim());
        formData.append(ENTRY_TIME, timeBox.value.trim());
        formData.append(ENTRY_ING, normalizeToPipes(ingredientsBox.value));
        formData.append(ENTRY_STEPS, normalizeToPipes(stepsBox.value));
        formData.append(ENTRY_NOTES, notesBox.value.trim());
        
        if(uploadedPhotoUrl) {
          formData.append(ENTRY_PHOTO, uploadedPhotoUrl);
        }

        setProgress(90, "Submitting to cookbook…");

        // Submit directly to Google Form
        await fetch(FORM_BASE, {
          method: "POST",
          body: formData,
          mode: "no-cors" // Required for Google Forms
        });

        setProgress(100, "Recipe submitted successfully!");

        // Show success message
        alert("Recipe submitted successfully! It will appear in the cookbook within a few minutes.");
        
        // Reset form
        resetAll();

      } catch(err) {
        console.error("Submission error:", err);
        alert("There was an error submitting the recipe. Please try again.");
      } finally {
        btnSubmit.disabled = false;
        status.style.display = "none";
      }
    });
  </script>
</body>
</html>
