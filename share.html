<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Share a Recipe</title>
  <style>
    :root{
      --cream:#FBF6EF;
      --primary:#e1b6b6;
      --green:#1a2f23;
      --brown:#8e7158;
      --paper:#ffffff;
      --shadow: 0 14px 35px rgba(0,0,0,.08);
      --radius: 18px;
      --serif: Georgia, "Times New Roman", serif;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }
    body{
      margin:0;
      font-family:var(--sans);
      background: linear-gradient(180deg, var(--cream), #fff);
      color:#2A2422;
      line-height:1.55;
    }
    .wrap{
      max-width:820px;
      margin:0 auto;
      padding:28px 18px 60px;
    }
    .card{
      background:var(--paper);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid rgba(142,113,88,.22);
      overflow:hidden;
    }
    .inner{ padding:20px; }
    h1{
      font-family:var(--serif);
      margin:0;
      font-size:28px;
      letter-spacing:.2px;
    }
    p{ margin:10px 0 0; color: rgba(42,36,34,.8); }
    .rule{
      height:2px; width:92px; border-radius:2px;
      background: linear-gradient(90deg, transparent, var(--brown), transparent);
      margin:12px 0 0;
      opacity:.8;
    }
    .row{ margin-top:18px; display:grid; gap:12px; }
    .upload{
      border:1px dashed rgba(26,47,35,.25);
      border-radius:16px;
      padding:14px;
      background: linear-gradient(180deg, rgba(225,182,182,.22), rgba(251,246,239,.95));
    }
    input[type="file"]{ width:100%; }
    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    button, a.btn{
      border: 1px solid rgba(26,47,35,.25);
      background: linear-gradient(180deg, rgba(225,182,182,.35), rgba(251,246,239,.98));
      color:#2A2422;
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-size: 13px;
      text-decoration:none;
      display:inline-block;
    }
    button.primary{
      border-color: rgba(26,47,35,.45);
    }
    .note{
      margin-top:12px;
      font-size:13px;
      padding:10px 12px;
      border-left:3px solid var(--brown);
      border-radius:14px;
      background: rgba(225,182,182,.18);
      color: rgba(42,36,34,.85);
      word-break: break-word;
    }
    .muted{ opacity:.75; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="inner">
        <h1>Share a Recipe</h1>
        <div class="rule"></div>
        <p class="muted">
          Upload a photo first (optional). Then the recipe form opens with the photo already attached.
        </p>

        <div class="row">
          <div class="upload">
            <label for="file"><strong>Recipe Photo (optional)</strong></label>
            <p class="muted" style="margin-top:6px;">JPG/PNG recommended.</p>
            <input id="file" type="file" accept="image/*" />
            <div class="actions">
              <button class="primary" id="uploadBtn" type="button">Upload Photo</button>
              <a class="btn" id="skipBtn" href="#" target="_blank" rel="noopener noreferrer">Skip Photo and Open Form</a>
            </div>
          </div>

          <div id="status" class="note" style="display:none;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Your Google Form + Photo URL prefill entry id
    const FORM_BASE = "https://docs.google.com/forms/d/e/1FAIpQLSdhYWTAHVid0Ec4kLCKRh2ZrHegYB8VjefEqBCLPx3VRFfEGw/viewform";
    const PHOTO_ENTRY = "entry.1845959569";

    const statusEl = document.getElementById("status");
    const fileEl = document.getElementById("file");
    const uploadBtn = document.getElementById("uploadBtn");
    const skipBtn = document.getElementById("skipBtn");

    function showStatus(msg) {
      statusEl.style.display = "block";
      statusEl.textContent = msg;
    }

    function openFormWithPhoto(url) {
      const target = `${FORM_BASE}?usp=pp_url&${PHOTO_ENTRY}=${encodeURIComponent(url)}`;
      window.open(target, "_blank", "noopener,noreferrer");
    }

    // Skip button always opens the form
    skipBtn.href = FORM_BASE;

    uploadBtn.addEventListener("click", async () => {
      const file = fileEl.files && fileEl.files[0];
      if (!file) {
        showStatus("Choose a photo first, or click “Skip Photo and Open Form.”");
        return;
      }

      showStatus("Uploading photo…");

      try {
        const fd = new FormData();
        fd.append("file", file);

        const res = await fetch("/api/upload", {
          method: "POST",
          body: fd,
        });

        if (!res.ok) {
          const t = await res.text();
          throw new Error(t || "Upload failed");
        }

        const data = await res.json();
        if (!data.url) throw new Error("No URL returned");

        showStatus("Photo uploaded. Opening the recipe form…");
        openFormWithPhoto(data.url);

      } catch (e) {
        console.error(e);
        showStatus("Upload failed. Try again, or click “Skip Photo and Open Form.”");
      }
    });
  </script>
</body>
</html>
