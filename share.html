<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Share a Recipe</title>
  <style>
    :root{
      --primary:#e1b6b6;
      --accent:#1a2f23;
      --accent2:#8e7158;
      --paper:#ffffff;
      --ink:#2A2422;
      --shadow:0 14px 35px rgba(0,0,0,.10);
      --radius:18px;
      --sans:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      --serif:Georgia, "Times New Roman", serif;
    }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--ink);
      background:
        radial-gradient(900px 520px at 12% 10%, rgba(225,182,182,.55), transparent 58%),
        radial-gradient(900px 520px at 88% 12%, rgba(26,47,35,.10), transparent 58%),
        linear-gradient(180deg, #fff, #fbf7f5);
    }
    .wrap{ max-width:920px; margin:0 auto; padding:22px 16px 60px; }
    .card{
      background:var(--paper);
      border-radius:26px;
      box-shadow:var(--shadow);
      border:1px solid rgba(142,113,88,.22);
      overflow:hidden;
    }
    header{
      padding:22px 18px 18px;
      background: linear-gradient(120deg, rgba(225,182,182,.85), rgba(255,255,255,.92) 55%, rgba(26,47,35,.06));
      border-bottom:1px solid rgba(142,113,88,.16);
    }
    h1{ margin:0; font-family:var(--serif); font-size:clamp(22px, 3.6vw, 32px); }
    p{ margin:10px 0 0; color:rgba(42,36,34,.78); font-size:14px; }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; padding:16px 18px 18px; }
    @media (max-width: 880px){ .grid{ grid-template-columns:1fr; } }

    .box{
      border:1px solid rgba(142,113,88,.20);
      border-radius:18px;
      background:rgba(255,255,255,.92);
      box-shadow: 0 10px 24px rgba(0,0,0,.05);
      padding:14px;
    }
    .box h2{ margin:0 0 10px; font-family:var(--serif); font-size:16px; }
    label{ display:block; font-size:12px; color:rgba(42,36,34,.72); margin:10px 0 6px; }
    input[type="text"], textarea{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(142,113,88,.22);
      padding:10px 11px;
      font-size:14px;
      outline:none;
    }
    textarea{ min-height:120px; resize:vertical; }

    .actions{ display:flex; flex-wrap:wrap; gap:10px; margin-top:12px; }
    button{
      border-radius:14px;
      border:1px solid rgba(142,113,88,.30);
      padding:10px 12px;
      font-size:13px;
      cursor:pointer;
      background: linear-gradient(180deg, rgba(225,182,182,.55), rgba(255,255,255,.95));
      color:var(--ink);
      transition: transform .08s ease;
    }
    button:hover{ transform: translateY(-1px); }
    button.primary{
      background: linear-gradient(180deg, rgba(26,47,35,.96), rgba(26,47,35,.90));
      border-color: rgba(26,47,35,.55);
      color:#fff;
    }
    button.secondary{
      background: linear-gradient(180deg, rgba(142,113,88,.22), rgba(255,255,255,.95));
    }
    .muted{ font-size:12px; color:rgba(42,36,34,.72); margin-top:10px; }
    .status{
      margin-top:10px;
      font-size:12px;
      color:rgba(42,36,34,.78);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .bar{
      flex:1;
      height:8px;
      border-radius:999px;
      background:rgba(142,113,88,.14);
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(26,47,35,.80), rgba(142,113,88,.70));
      transition: width .15s ease;
    }
    .preview{
      display:grid;
      gap:10px;
    }
    .imgWrap{
      border-radius:18px;
      border:1px solid rgba(142,113,88,.20);
      background:rgba(251,247,245,.8);
      overflow:hidden;
    }
    img{ width:100%; height:auto; display:block; }
    .smallNote{
      font-size:12px;
      color:rgba(42,36,34,.72);
      line-height:1.4;
    }
  </style>

  <!-- Tesseract.js (browser OCR) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <header>
        <h1>Share a Recipe</h1>
        <p>Upload a typed recipe card photo, extract the text, then send it into the Family & Friends Cookbook form.</p>
      </header>

      <div class="grid">

        <!-- LEFT: Upload + OCR -->
        <div class="box">
          <h2>1) Upload recipe photo</h2>

          <label>Recipe photo (typed card works best)</label>
          <input id="photoInput" type="file" accept="image/*" />

          <div class="preview" style="margin-top:12px;">
            <div class="imgWrap" id="imgWrap" style="display:none;">
              <img id="previewImg" alt="Recipe preview"/>
            </div>

            <div class="actions">
              <button type="button" class="secondary" id="btnExtract" disabled>Extract Text (OCR)</button>
              <button type="button" id="btnClear" disabled>Clear</button>
            </div>

            <div class="status" id="status" style="display:none;">
              <span id="statusText">Preparing OCR…</span>
              <div class="bar"><div id="barFill"></div></div>
            </div>

            <div class="smallNote">
              Tip: crop tight around the recipe text before uploading for the cleanest results.
            </div>
          </div>
        </div>

        <!-- RIGHT: Results + Send -->
        <div class="box">
          <h2>2) Review & send to Google Form</h2>

          <label>Ingredients (auto-filled)</label>
          <textarea id="ingredientsBox" placeholder="OCR will try to place ingredients here…"></textarea>

          <label>Steps (auto-filled)</label>
          <textarea id="stepsBox" placeholder="OCR will try to place steps here…"></textarea>

          <label>Notes (optional)</label>
          <input id="notesBox" type="text" placeholder="Example: 'Aunt Linda’s card from 1998'"/>

          <div class="actions">
            <button type="button" class="primary" id="btnGoForm" disabled>Continue to Google Form</button>
          </div>
          <div class="muted">
            You can edit the text before submitting. The photo stays the “source of truth.”
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    // === CONFIG: Put your Google Form base URL here ===
    const FORM_BASE =
      "https://docs.google.com/forms/d/e/1FAIpQLSdhYWTAHVid0Ec4kLCKRh2ZrHegYB8VjefEqBCLPx3VRFfEGw/viewform";

    // === CONFIG: Put your Google Form *prefill* entry IDs here ===
    // You ALREADY have Photo URL: entry.1845959569 (keep it)
    // Replace the ??? with the correct IDs for Ingredients + Steps + Notes.
    const ENTRY_TITLE = "entry.1770944788";
    const ENTRY_ING   = "entry.991892970";
    const ENTRY_STEPS = "entry.1029695301";
    const ENTRY_PHOTO = "entry.1845959569";

    // If you don't want to prefill Notes, you can leave ENTRY_NOTES blank and we won't include it.

    const photoInput = document.getElementById("photoInput");
    const btnExtract = document.getElementById("btnExtract");
    const btnClear = document.getElementById("btnClear");
    const btnGoForm = document.getElementById("btnGoForm");

    const imgWrap = document.getElementById("imgWrap");
    const previewImg = document.getElementById("previewImg");

    const status = document.getElementById("status");
    const statusText = document.getElementById("statusText");
    const barFill = document.getElementById("barFill");

    const ingredientsBox = document.getElementById("ingredientsBox");
    const stepsBox = document.getElementById("stepsBox");
    const notesBox = document.getElementById("notesBox");

    let fileBlob = null;

    function setProgress(pct, msg){
      status.style.display = "flex";
      statusText.textContent = msg || "Working…";
      barFill.style.width = `${Math.max(0, Math.min(100, pct))}%`;
    }

    function resetAll(){
      fileBlob = null;
      photoInput.value = "";
      imgWrap.style.display = "none";
      previewImg.src = "";
      btnExtract.disabled = true;
      btnClear.disabled = true;
      btnGoForm.disabled = true;
      status.style.display = "none";
      barFill.style.width = "0%";
      ingredientsBox.value = "";
      stepsBox.value = "";
      notesBox.value = "";
    }

    photoInput.addEventListener("change", () => {
      const file = photoInput.files && photoInput.files[0];
      if(!file) return;

      fileBlob = file;

      const url = URL.createObjectURL(file);
      previewImg.src = url;
      imgWrap.style.display = "block";

      btnExtract.disabled = false;
      btnClear.disabled = false;
      btnGoForm.disabled = false; // allow form even if they skip OCR
    });

    btnClear.addEventListener("click", resetAll);

    // Simple heuristic splitter for typed cards:
    // We try to locate an "Ingredients" block and an "Instructions/Steps" block.
    function splitIntoIngredientsAndSteps(text){
      const clean = (text || "").replace(/\r/g, "").trim();

      // Try common headings
      const lower = clean.toLowerCase();
      const idxIng = lower.indexOf("ingredients");
      const idxSteps = Math.max(
        lower.indexOf("instructions"),
        lower.indexOf("directions"),
        lower.indexOf("steps"),
        lower.indexOf("method")
      );

      if(idxIng !== -1 && idxSteps !== -1 && idxSteps > idxIng){
        const ingBlock = clean.slice(idxIng, idxSteps).replace(/ingredients\s*:?\s*/i, "").trim();
        const stepBlock = clean.slice(idxSteps).replace(/(instructions|directions|steps|method)\s*:?\s*/i, "").trim();
        return { ingredients: ingBlock, steps: stepBlock };
      }

      // If no headings, fall back: first ~40% lines as ingredients
      const lines = clean.split("\n").map(l => l.trim()).filter(Boolean);
      const cut = Math.max(3, Math.floor(lines.length * 0.4));
      return {
        ingredients: lines.slice(0, cut).join("\n"),
        steps: lines.slice(cut).join("\n")
      };
    }

    btnExtract.addEventListener("click", async () => {
      if(!fileBlob) return;

      try{
        btnExtract.disabled = true;
        setProgress(2, "Starting OCR…");

        // Run OCR in browser
        const { data } = await Tesseract.recognize(
          fileBlob,
          "eng",
          {
            logger: m => {
              if(m.status === "recognizing text" && m.progress != null){
                setProgress(10 + Math.round(m.progress * 90), `Reading text… ${Math.round(m.progress * 100)}%`);
              } else if (m.status){
                setProgress(8, m.status);
              }
            }
          }
        );

        const raw = (data && data.text) ? data.text : "";
        const { ingredients, steps } = splitIntoIngredientsAndSteps(raw);

        ingredientsBox.value = ingredients || "";
        stepsBox.value = steps || "";

        setProgress(100, "Done. Review & edit the text.");
        setTimeout(() => { status.style.display = "none"; }, 900);
      } catch (err){
        console.error(err);
        setProgress(100, "OCR failed. You can still continue to the form.");
        btnExtract.disabled = false;
      } finally {
        btnExtract.disabled = false;
      }
    });

    // If you ALSO want to include a photo URL in the form:
    // - For fast test we do NOT upload anywhere; the photo stays local.
    // - If you want the photo URL to show on the site, use your existing upload flow (Vercel Blob)
    //   and set photoUrlValue to the returned URL.
    //
    // For now, we leave Photo URL blank unless you already generate it elsewhere.
    let photoUrlValue = ""; // set this if you're generating a URL via your upload endpoint

    btnGoForm.addEventListener("click", () => {
      const params = new URLSearchParams();

      // Prefill fields if IDs are set
      if(ENTRY_ING && !ENTRY_ING.includes("?")) params.set(ENTRY_ING, ingredientsBox.value.trim());
      if(ENTRY_STEPS && !ENTRY_STEPS.includes("?")) params.set(ENTRY_STEPS, stepsBox.value.trim());
      if(ENTRY_NOTES && !ENTRY_NOTES.includes("?")) params.set(ENTRY_NOTES, notesBox.value.trim());
      if(ENTRY_PHOTO_URL && photoUrlValue) params.set(ENTRY_PHOTO_URL, photoUrlValue);

      const url = `${FORM_BASE}?usp=pp_url&${params.toString()}`;
      window.location.href = url;
    });

    // start clean
    resetAll();
  </script>
</body>
</html>
