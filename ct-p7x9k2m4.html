<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PDF Signer">
    <meta name="theme-color" content="#0D6B58">
    <title>PDF Signer & Editor Pro | CompliTrst‚Ñ¢</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/tkdbrad03/assets/main/complitrst-favicon.png">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/tkdbrad03/assets/main/complitrst-favicon.png">
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        :root {
            --teal: #0D6B58;
            --teal-dark: #0A5647;
            --teal-light: #0E7D66;
            --gold: #C9A227;
            --gold-dark: #B8921F;
            --bg: #F5F5F5;
            --card: #FFFFFF;
            --text: #1A1A1A;
            --text-muted: #6B7280;
            --border: #E5E7EB;
            --danger: #C0392B;
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --safe-top: env(safe-area-inset-top, 0px);
        }

        html, body {
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        .app {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding-top: var(--safe-top);
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            background: var(--teal);
            color: white;
            flex-shrink: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-logo {
            height: 28px;
            display: none;
        }

        .header-title {
            font-size: 1rem;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .header-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
        }

        .header-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .header-btn.primary { background: var(--gold); }

        /* Main Layout */
        .main {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        /* Upload Screen */
        .upload-screen {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
            background: var(--bg);
            z-index: 10;
        }

        .upload-screen.hidden { display: none; }

        .upload-icon {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--teal), var(--teal-light));
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            margin-bottom: 24px;
            color: white;
        }

        .upload-screen h2 { font-size: 1.5rem; margin-bottom: 8px; }
        .upload-screen p { color: var(--text-muted); margin-bottom: 24px; }

        .upload-btn {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        #file-input { display: none; }

        /* PDF Viewer */
        .pdf-viewer {
            flex: 1;
            overflow: auto;
            background: #404040;
            display: none;
            position: relative;
            -webkit-overflow-scrolling: touch;
        }

        .pdf-viewer.active { display: block; }

        .pdf-container {
            min-height: 100%;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 15px;
        }

        .pdf-wrapper {
            position: relative;
            background: white;
            box-shadow: 0 4px 30px rgba(0,0,0,0.3);
        }

        #pdf-canvas { display: block; cursor: crosshair; }

        /* Text Layer for Edit Mode */
        .text-layer {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        .text-item {
            position: absolute;
            cursor: text;
            pointer-events: auto;
            border: 1px solid transparent;
            white-space: pre;
            color: transparent;
            background: transparent;
        }

        .text-item:hover {
            background: rgba(201, 162, 39, 0.3);
            border-color: var(--gold);
            border-style: dashed;
        }

        .text-item.modified {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #4CAF50;
            color: #000;
        }

        /* Element Overlays */
        .element-overlay {
            position: absolute;
            cursor: move;
            border: 2px dashed var(--teal);
            background: rgba(255,255,255,0.95);
            user-select: none;
            touch-action: none;
        }

        .element-overlay.signature-el,
        .element-overlay.initials-el { padding: 4px; }
        .element-overlay.text-el,
        .element-overlay.date-el { padding: 2px 6px; }
        .element-overlay.checkbox-el {
            padding: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            min-height: 24px;
        }

        .element-overlay img {
            display: block;
            pointer-events: none;
        }

        .el-controls {
            position: absolute;
            top: -28px;
            right: 0;
            display: flex;
            gap: 2px;
        }

        .el-remove {
            width: 24px;
            height: 24px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .resize-handle {
            position: absolute;
            bottom: -5px;
            right: -5px;
            width: 10px;
            height: 10px;
            background: var(--gold);
            border: 2px solid white;
            border-radius: 2px;
            cursor: se-resize;
        }

        /* Page Controls */
        .page-controls {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.85rem;
            z-index: 20;
        }

        .page-controls button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .page-controls button:disabled { opacity: 0.3; }

        .zoom-btns {
            display: flex;
            gap: 4px;
            margin-left: 8px;
            padding-left: 8px;
            border-left: 1px solid rgba(255,255,255,0.3);
        }

        .zoom-btns button {
            width: 24px;
            height: 24px;
            font-size: 0.8rem;
        }

        .zoom-level {
            font-size: 0.75rem;
            min-width: 35px;
            text-align: center;
        }

        /* Desktop Sidebar */
        .sidebar {
            width: 340px;
            background: var(--card);
            border-left: 1px solid var(--border);
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar.active { display: flex; }

        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            overflow-x: auto;
        }

        .sidebar-tab {
            flex: 1;
            min-width: 60px;
            padding: 12px 8px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-muted);
            white-space: nowrap;
        }

        .sidebar-tab.active {
            color: var(--teal);
            border-bottom-color: var(--teal);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .sidebar-panel { display: none; }
        .sidebar-panel.active { display: block; }

        .panel-section { margin-bottom: 20px; }
        .panel-section h4 {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text);
        }

        .panel-section p.hint {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        /* Signature/Initials Pad */
        .sig-pad-wrap {
            border: 2px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 10px;
            background: white;
        }

        .sig-pad {
            width: 100%;
            height: 100px;
            display: block;
            cursor: crosshair;
        }

        .sig-pad.initials { height: 70px; }

        .pen-options {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .pen-options input[type="range"] { width: 80px; }
        .pen-options input[type="color"] { width: 30px; height: 24px; border: none; cursor: pointer; }

        .btn-row {
            display: flex;
            gap: 8px;
        }

        .btn {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--border);
            background: white;
        }

        .btn-clear { color: var(--danger); border-color: var(--danger); }
        .btn-save { color: var(--teal); border-color: var(--teal); }
        .btn-primary { background: var(--teal); color: white; border: none; }

        /* Saved Signatures */
        .saved-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .saved-item {
            position: relative;
            border: 2px solid var(--border);
            border-radius: 6px;
            padding: 6px;
            background: white;
            cursor: pointer;
        }

        .saved-item:hover { border-color: var(--gold); }
        .saved-item.selected { border-color: var(--teal); box-shadow: 0 0 0 2px rgba(13,107,88,0.2); }

        .saved-item img { height: 30px; display: block; }

        .saved-item .delete-btn {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 16px;
            height: 16px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 10px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .saved-item:hover .delete-btn { display: flex; }

        .empty-state {
            color: var(--text-muted);
            font-size: 0.8rem;
            font-style: italic;
        }

        /* Text Input */
        .text-input-wrap {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .text-input-wrap input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .text-options {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .text-options select {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .text-options input[type="color"] {
            width: 40px;
            height: 36px;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
        }

        /* Quick Tools */
        .quick-tools {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .quick-tool {
            padding: 10px 14px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .quick-tool:hover {
            background: var(--teal);
            color: white;
            border-color: var(--teal);
        }

        /* Date Formats */
        .date-formats {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .date-format-btn {
            padding: 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            text-align: center;
        }

        .date-format-btn:hover { border-color: var(--teal); }
        .date-format-btn.selected {
            background: rgba(13,107,88,0.1);
            border-color: var(--teal);
            color: var(--teal);
            font-weight: 600;
        }

        /* Checkbox Styles */
        .checkbox-options {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .checkbox-style {
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            background: white;
        }

        .checkbox-style:hover { border-color: var(--teal); }
        .checkbox-style.selected {
            border-color: var(--teal);
            background: rgba(13,107,88,0.1);
        }

        /* Find & Replace */
        .find-replace {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .find-replace input {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .find-replace button {
            padding: 10px;
            background: var(--teal);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Edit List */
        .edit-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .edit-item {
            background: var(--bg);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }

        .edit-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .edit-item-page { color: var(--teal); font-weight: 600; }
        .edit-item-remove {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 1rem;
        }

        .edit-item-original {
            text-decoration: line-through;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .edit-item-new { color: #4CAF50; }

        /* Edit Instructions */
        .edit-instructions {
            background: rgba(201,162,39,0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .edit-instructions strong { color: var(--gold-dark); }
        .edit-instructions p { font-size: 0.85rem; color: var(--text-muted); margin-top: 6px; }

        /* Mobile Toolbar */
        .mobile-toolbar {
            display: none;
            background: var(--card);
            border-top: 1px solid var(--border);
            padding: 6px 0;
            padding-bottom: calc(6px + var(--safe-bottom));
            flex-shrink: 0;
        }

        .mobile-toolbar.active { display: block; }

        .toolbar-icons {
            display: flex;
            justify-content: space-around;
        }

        .tool-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            background: none;
            border: none;
            padding: 6px 12px;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 0.7rem;
        }

        .tool-btn .icon { font-size: 20px; }

        /* Mobile Sheets */
        .sheet-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            z-index: 100;
        }

        .sheet-overlay.active { opacity: 1; visibility: visible; }

        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card);
            border-radius: 16px 16px 0 0;
            transform: translateY(100%);
            transition: transform 0.3s ease-out;
            z-index: 101;
            max-height: 80vh;
            overflow-y: auto;
            padding-bottom: var(--safe-bottom);
        }

        .bottom-sheet.active { transform: translateY(0); }

        .sheet-handle {
            width: 36px;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin: 10px auto;
        }

        .sheet-header {
            padding: 0 16px 12px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sheet-header h3 { font-size: 1rem; }
        .sheet-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-muted);
            cursor: pointer;
        }

        .sheet-content { padding: 16px; }

        /* Edit Modal */
        .edit-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 20px;
        }

        .edit-modal.active { display: flex; }

        .edit-modal-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            width: 100%;
            max-width: 400px;
        }

        .edit-modal-content h3 { margin-bottom: 12px; }

        .edit-modal-content input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .edit-modal-content .original-text {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .edit-modal-buttons {
            display: flex;
            gap: 10px;
        }

        .edit-modal-buttons button {
            flex: 1;
            padding: 12px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-cancel {
            background: white;
            border: 1px solid var(--border);
            color: var(--text-muted);
        }

        .btn-apply {
            background: var(--teal);
            border: none;
            color: white;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 0.9rem;
            z-index: 300;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .toast.show { opacity: 1; }

        /* Responsive */
        @media (min-width: 768px) {
            .header-logo { display: block; }
            .sidebar.active { display: flex; }
            .mobile-toolbar { display: none !important; }
            .bottom-sheet, .sheet-overlay { display: none !important; }
            .pdf-container { padding: 25px; }
        }

        @media (max-width: 767px) {
            .sidebar { display: none !important; }
            .mobile-toolbar.active { display: block; }
            .header-btn span.full { display: none; }
            .pdf-container { padding: 10px; padding-bottom: 70px; }
            .page-controls { bottom: 10px; padding: 6px 12px; font-size: 0.8rem; }
            .page-controls .zoom-btns { 
                display: flex;
                margin-left: 6px;
                padding-left: 6px;
            }
            .page-controls .zoom-btns button {
                width: 28px;
                height: 28px;
                font-size: 1rem;
            }
            .page-controls .zoom-level {
                min-width: 40px;
                font-size: 0.7rem;
            }
            .toast { bottom: 140px; }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <img src="https://raw.githubusercontent.com/tkdbrad03/assets/main/complitrst-logo_transparent.png" alt="CompliTrst" class="header-logo">
                <span class="header-title">PDF Signer & Editor Pro</span>
            </div>
            <div class="header-actions">
                <button class="header-btn" id="change-file-btn" style="display:none;">Change</button>
                <button class="header-btn primary" id="download-btn" disabled>‚¨áÔ∏è <span class="full">Download</span></button>
            </div>
        </div>

        <!-- Main -->
        <div class="main">
            <!-- Upload Screen -->
            <div class="upload-screen" id="upload-screen">
                <div class="upload-icon">üìÑ</div>
                <h2>Open a PDF</h2>
                <p>Sign, edit, and own your documents</p>
                <button class="upload-btn" id="upload-btn">Choose File</button>
                <input type="file" id="file-input" accept=".pdf">
            </div>

            <!-- PDF Viewer -->
            <div class="pdf-viewer" id="pdf-viewer">
                <div class="pdf-container">
                    <div class="pdf-wrapper" id="pdf-wrapper">
                        <canvas id="pdf-canvas"></canvas>
                        <div class="text-layer" id="text-layer"></div>
                    </div>
                </div>
                <div class="page-controls">
                    <button id="prev-page">‚óÄ</button>
                    <span><span id="current-page">1</span> / <span id="total-pages">1</span></span>
                    <button id="next-page">‚ñ∂</button>
                    <div class="zoom-btns">
                        <button id="zoom-out">‚àí</button>
                        <span class="zoom-level" id="zoom-level">100%</span>
                        <button id="zoom-in">+</button>
                        <button id="zoom-fit" style="margin-left:4px;width:auto;padding:0 8px;font-size:0.7rem;">Fit</button>
                    </div>
                </div>
            </div>

            <!-- Desktop Sidebar -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-tabs">
                    <button class="sidebar-tab active" data-tab="sign">‚úçÔ∏è Sign</button>
                    <button class="sidebar-tab" data-tab="text">üìù Text</button>
                    <button class="sidebar-tab" data-tab="date">üìÖ Date</button>
                    <button class="sidebar-tab" data-tab="edit">‚úèÔ∏è Edit</button>
                    <button class="sidebar-tab" data-tab="more">‚ûï More</button>
                </div>
                <div class="sidebar-content">
                    <!-- Sign Panel -->
                    <div class="sidebar-panel active" id="panel-sign">
                        <div class="panel-section">
                            <h4>Draw Signature</h4>
                            <div class="pen-options">
                                <span>Width:</span>
                                <input type="range" id="sig-pen-width" min="1" max="6" value="2">
                                <input type="color" id="sig-pen-color" value="#000000">
                            </div>
                            <div class="sig-pad-wrap">
                                <canvas class="sig-pad" id="sig-pad"></canvas>
                            </div>
                            <div class="btn-row">
                                <button class="btn btn-clear" id="sig-clear">Clear</button>
                                <button class="btn btn-save" id="sig-save">Save</button>
                            </div>
                        </div>
                        <div class="panel-section">
                            <h4>Saved Signatures <span style="font-weight:normal;color:#999;">(click to use)</span></h4>
                            <div class="saved-list" id="sig-list"><p class="empty-state">No signatures saved yet</p></div>
                        </div>
                        <div class="panel-section">
                            <h4>Draw Initials</h4>
                            <div class="sig-pad-wrap">
                                <canvas class="sig-pad initials" id="initials-pad"></canvas>
                            </div>
                            <div class="btn-row">
                                <button class="btn btn-clear" id="initials-clear">Clear</button>
                                <button class="btn btn-save" id="initials-save">Save</button>
                            </div>
                        </div>
                        <div class="panel-section">
                            <h4>Saved Initials</h4>
                            <div class="saved-list" id="initials-list"><p class="empty-state">No initials saved yet</p></div>
                        </div>
                    </div>

                    <!-- Text Panel -->
                    <div class="sidebar-panel" id="panel-text">
                        <div class="panel-section">
                            <h4>Add Text</h4>
                            <div class="text-input-wrap">
                                <input type="text" id="text-input" placeholder="Type your text...">
                                <button class="btn btn-primary" id="add-text-btn">Add</button>
                            </div>
                            <div class="text-options">
                                <select id="text-font">
                                    <option value="Helvetica">Helvetica</option>
                                    <option value="Times-Roman">Times</option>
                                    <option value="Courier">Courier</option>
                                </select>
                                <select id="text-size">
                                    <option value="10">10px</option>
                                    <option value="12" selected>12px</option>
                                    <option value="14">14px</option>
                                    <option value="16">16px</option>
                                    <option value="18">18px</option>
                                    <option value="24">24px</option>
                                </select>
                                <input type="color" id="text-color" value="#000000">
                            </div>
                        </div>
                        <div class="panel-section">
                            <h4>Quick Text</h4>
                            <div class="quick-tools">
                                <div class="quick-tool" data-text="Approved">‚úì Approved</div>
                                <div class="quick-tool" data-text="Rejected">‚úó Rejected</div>
                                <div class="quick-tool" data-text="DRAFT">DRAFT</div>
                                <div class="quick-tool" data-text="CONFIDENTIAL">üîí CONFIDENTIAL</div>
                            </div>
                        </div>
                    </div>

                    <!-- Date Panel -->
                    <div class="sidebar-panel" id="panel-date">
                        <div class="panel-section">
                            <h4>Add Date Stamp</h4>
                            <p class="hint">Select format, then click on PDF</p>
                            <div class="date-formats" id="date-formats"></div>
                        </div>
                        <div class="panel-section">
                            <div class="text-options">
                                <select id="date-font">
                                    <option value="Helvetica">Helvetica</option>
                                    <option value="Times-Roman">Times</option>
                                    <option value="Courier">Courier</option>
                                </select>
                                <select id="date-size">
                                    <option value="10">10px</option>
                                    <option value="12" selected>12px</option>
                                    <option value="14">14px</option>
                                    <option value="16">16px</option>
                                </select>
                                <input type="color" id="date-color" value="#000000">
                            </div>
                        </div>
                    </div>

                    <!-- Edit Panel -->
                    <div class="sidebar-panel" id="panel-edit">
                        <div class="edit-instructions">
                            <strong>üí° How to Edit Text</strong>
                            <p>Hover over text in the PDF ‚Äî it will highlight. Click to edit.</p>
                        </div>
                        <div class="panel-section">
                            <h4>Find & Replace</h4>
                            <div class="find-replace">
                                <input type="text" id="find-input" placeholder="Find text...">
                                <input type="text" id="replace-input" placeholder="Replace with...">
                                <button id="replace-all-btn">Replace All</button>
                            </div>
                        </div>
                        <div class="panel-section">
                            <h4>Text Edits <span style="font-weight:normal;color:#999;">(<span id="edit-count">0</span>)</span></h4>
                            <div class="edit-list" id="edit-list"><p class="empty-state">No text edits yet</p></div>
                        </div>
                    </div>

                    <!-- More Panel -->
                    <div class="sidebar-panel" id="panel-more">
                        <div class="panel-section">
                            <h4>Checkboxes</h4>
                            <p class="hint">Select style, then click on PDF</p>
                            <div class="checkbox-options" id="checkbox-options">
                                <div class="checkbox-style selected" data-style="‚úì">‚úì</div>
                                <div class="checkbox-style" data-style="‚úó">‚úó</div>
                                <div class="checkbox-style" data-style="‚òë">‚òë</div>
                                <div class="checkbox-style" data-style="‚òê">‚òê</div>
                                <div class="checkbox-style" data-style="‚óè">‚óè</div>
                            </div>
                        </div>
                        <div class="panel-section">
                            <h4>Quick Actions</h4>
                            <div class="btn-row">
                                <button class="btn" id="clear-page-btn">üóëÔ∏è Clear Page</button>
                                <button class="btn" id="clear-all-btn">üóëÔ∏è Clear All</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Toolbar -->
        <div class="mobile-toolbar" id="mobile-toolbar">
            <div class="toolbar-icons">
                <button class="tool-btn" data-sheet="sign-sheet"><span class="icon">‚úçÔ∏è</span><span>Sign</span></button>
                <button class="tool-btn" data-sheet="text-sheet"><span class="icon">üìù</span><span>Text</span></button>
                <button class="tool-btn" data-sheet="date-sheet"><span class="icon">üìÖ</span><span>Date</span></button>
                <button class="tool-btn" data-sheet="edit-sheet"><span class="icon">‚úèÔ∏è</span><span>Edit</span></button>
                <button class="tool-btn" data-sheet="more-sheet"><span class="icon">‚ûï</span><span>More</span></button>
            </div>
        </div>
    </div>

    <!-- Sheet Overlay -->
    <div class="sheet-overlay" id="sheet-overlay"></div>

    <!-- Mobile Sign Sheet -->
    <div class="bottom-sheet" id="sign-sheet">
        <div class="sheet-handle"></div>
        <div class="sheet-header"><h3>Signatures & Initials</h3><button class="sheet-close" data-close>√ó</button></div>
        <div class="sheet-content">
            <div class="panel-section">
                <h4>Draw Signature</h4>
                <div class="sig-pad-wrap"><canvas class="sig-pad" id="m-sig-pad"></canvas></div>
                <div class="btn-row">
                    <button class="btn btn-clear" id="m-sig-clear">Clear</button>
                    <button class="btn btn-save" id="m-sig-save">Save</button>
                </div>
            </div>
            <div class="panel-section">
                <h4>Saved Signatures</h4>
                <div class="saved-list" id="m-sig-list"><p class="empty-state">No signatures saved yet</p></div>
            </div>
            <div class="panel-section">
                <h4>Draw Initials</h4>
                <div class="sig-pad-wrap"><canvas class="sig-pad initials" id="m-initials-pad"></canvas></div>
                <div class="btn-row">
                    <button class="btn btn-clear" id="m-initials-clear">Clear</button>
                    <button class="btn btn-save" id="m-initials-save">Save</button>
                </div>
            </div>
            <div class="panel-section">
                <h4>Saved Initials</h4>
                <div class="saved-list" id="m-initials-list"><p class="empty-state">No initials saved yet</p></div>
            </div>
        </div>
    </div>

    <!-- Mobile Text Sheet -->
    <div class="bottom-sheet" id="text-sheet">
        <div class="sheet-handle"></div>
        <div class="sheet-header"><h3>Add Text</h3><button class="sheet-close" data-close>√ó</button></div>
        <div class="sheet-content">
            <div class="panel-section">
                <div class="text-input-wrap">
                    <input type="text" id="m-text-input" placeholder="Type your text...">
                    <button class="btn btn-primary" id="m-add-text-btn">Add</button>
                </div>
                <div class="text-options">
                    <select id="m-text-size">
                        <option value="12">12px</option>
                        <option value="14" selected>14px</option>
                        <option value="16">16px</option>
                        <option value="18">18px</option>
                    </select>
                    <input type="color" id="m-text-color" value="#000000">
                </div>
            </div>
            <div class="panel-section">
                <h4>Quick Text</h4>
                <div class="quick-tools">
                    <div class="quick-tool m-quick" data-text="Approved">‚úì Approved</div>
                    <div class="quick-tool m-quick" data-text="Rejected">‚úó Rejected</div>
                    <div class="quick-tool m-quick" data-text="DRAFT">DRAFT</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Date Sheet -->
    <div class="bottom-sheet" id="date-sheet">
        <div class="sheet-handle"></div>
        <div class="sheet-header"><h3>Add Date</h3><button class="sheet-close" data-close>√ó</button></div>
        <div class="sheet-content">
            <div class="date-formats" id="m-date-formats"></div>
        </div>
    </div>

    <!-- Mobile Edit Sheet -->
    <div class="bottom-sheet" id="edit-sheet">
        <div class="sheet-handle"></div>
        <div class="sheet-header"><h3>Edit Text</h3><button class="sheet-close" data-close>√ó</button></div>
        <div class="sheet-content">
            <div class="edit-instructions">
                <strong>üí° Tap text in PDF to edit</strong>
                <p>Text will highlight when you hover/tap on it.</p>
            </div>
            <div class="panel-section">
                <h4>Find & Replace</h4>
                <div class="find-replace">
                    <input type="text" id="m-find-input" placeholder="Find text...">
                    <input type="text" id="m-replace-input" placeholder="Replace with...">
                    <button id="m-replace-all-btn">Replace All</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile More Sheet -->
    <div class="bottom-sheet" id="more-sheet">
        <div class="sheet-handle"></div>
        <div class="sheet-header"><h3>More Tools</h3><button class="sheet-close" data-close>√ó</button></div>
        <div class="sheet-content">
            <div class="panel-section">
                <h4>Checkboxes</h4>
                <div class="checkbox-options" id="m-checkbox-options">
                    <div class="checkbox-style selected" data-style="‚úì">‚úì</div>
                    <div class="checkbox-style" data-style="‚úó">‚úó</div>
                    <div class="checkbox-style" data-style="‚òë">‚òë</div>
                    <div class="checkbox-style" data-style="‚òê">‚òê</div>
                    <div class="checkbox-style" data-style="‚óè">‚óè</div>
                </div>
            </div>
            <div class="panel-section">
                <div class="btn-row">
                    <button class="btn" id="m-clear-page-btn">üóëÔ∏è Clear Page</button>
                    <button class="btn" id="m-clear-all-btn">üóëÔ∏è Clear All</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="edit-modal" id="edit-modal">
        <div class="edit-modal-content">
            <h3>Edit Text</h3>
            <input type="text" id="edit-input" placeholder="Enter new text...">
            <p class="original-text">Original: <span id="original-text"></span></p>
            <div class="edit-modal-buttons">
                <button class="btn-cancel" id="edit-cancel">Cancel</button>
                <button class="btn-apply" id="edit-apply">Apply</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js';

        // ========== STATE ==========
        let pdfDoc = null, pdfBytes = null, currentPage = 1, totalPages = 0, scale = 1.0;
        let signatures = JSON.parse(localStorage.getItem('ctSignatures') || '[]');
        let initials = JSON.parse(localStorage.getItem('ctInitials') || '[]');
        let selectedSignature = null, selectedInitials = null, selectedDateFormat = null;
        let selectedCheckboxStyle = '‚úì', currentTool = 'signature';
        let placedElements = [], textItems = [], textEdits = [], currentEditItem = null;
        let isMobile = window.innerWidth < 768;

        // Date formats
        const dateFormats = [
            { fn: () => new Date().toLocaleDateString('en-US') },
            { fn: () => new Date().toLocaleDateString('en-GB') },
            { fn: () => new Date().toISOString().split('T')[0] },
            { fn: () => new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) },
            { fn: () => new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) },
        ];

        // ========== DOM ==========
        const uploadScreen = document.getElementById('upload-screen');
        const pdfViewer = document.getElementById('pdf-viewer');
        const sidebar = document.getElementById('sidebar');
        const mobileToolbar = document.getElementById('mobile-toolbar');
        const pdfCanvas = document.getElementById('pdf-canvas');
        const pdfWrapper = document.getElementById('pdf-wrapper');
        const textLayer = document.getElementById('text-layer');
        const sheetOverlay = document.getElementById('sheet-overlay');
        const editModal = document.getElementById('edit-modal');
        const toast = document.getElementById('toast');

        // ========== INIT ==========
        function init() {
            initDateFormats();
            initCheckboxStyles();
            initTabs();
            initSignaturePads();
            initMobileSheets();
            renderSignatures();
            renderInitials();
        }

        function initDateFormats() {
            ['date-formats', 'm-date-formats'].forEach(id => {
                const container = document.getElementById(id);
                container.innerHTML = dateFormats.map((df, i) => 
                    `<div class="date-format-btn" data-index="${i}">${df.fn()}</div>`
                ).join('');

                container.querySelectorAll('.date-format-btn').forEach(btn => {
                    btn.onclick = () => {
                        document.querySelectorAll('.date-format-btn').forEach(b => b.classList.remove('selected'));
                        btn.classList.add('selected');
                        selectedDateFormat = parseInt(btn.dataset.index);
                        currentTool = 'date';
                        clearSelections();
                        closeAllSheets();
                        showToast('Tap on PDF to place date');
                    };
                });
            });
        }

        function initCheckboxStyles() {
            ['checkbox-options', 'm-checkbox-options'].forEach(id => {
                document.querySelectorAll(`#${id} .checkbox-style`).forEach(btn => {
                    btn.onclick = () => {
                        document.querySelectorAll('.checkbox-style').forEach(b => b.classList.remove('selected'));
                        btn.classList.add('selected');
                        selectedCheckboxStyle = btn.dataset.style;
                        currentTool = 'checkbox';
                        clearSelections();
                        closeAllSheets();
                        showToast('Tap on PDF to place checkbox');
                    };
                });
            });
        }

        function initTabs() {
            document.querySelectorAll('.sidebar-tab').forEach(tab => {
                tab.onclick = () => {
                    document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.sidebar-panel').forEach(p => p.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById('panel-' + tab.dataset.tab).classList.add('active');
                };
            });
        }

        function initMobileSheets() {
            document.querySelectorAll('.tool-btn[data-sheet]').forEach(btn => {
                btn.onclick = () => openSheet(btn.dataset.sheet);
            });

            sheetOverlay.onclick = closeAllSheets;
            document.querySelectorAll('[data-close]').forEach(btn => {
                btn.onclick = closeAllSheets;
            });
        }

        function openSheet(id) {
            sheetOverlay.classList.add('active');
            document.getElementById(id).classList.add('active');
            // Wait for sheet animation to complete before initializing canvas
            setTimeout(() => initMobilePads(), 350);
        }

        function closeAllSheets() {
            sheetOverlay.classList.remove('active');
            document.querySelectorAll('.bottom-sheet').forEach(s => s.classList.remove('active'));
        }

        // ========== SIGNATURE PADS ==========
        const padContexts = {};

        function initSignaturePads() {
            // Desktop pads - initialize immediately
            setupPad('sig-pad', 'sig-clear', 'sig-save', 'sig-pen-width', 'sig-pen-color', 'signature');
            setupPad('initials-pad', 'initials-clear', 'initials-save', null, null, 'initials');
            
            // Mobile pads - just set up buttons, canvas init happens when sheet opens
            setupMobilePadButtons('m-sig-pad', 'm-sig-clear', 'm-sig-save', 'signature');
            setupMobilePadButtons('m-initials-pad', 'm-initials-clear', 'm-initials-save', 'initials');
        }

        function initMobilePads() {
            ['m-sig-pad', 'm-initials-pad'].forEach(id => {
                const canvas = document.getElementById(id);
                if (!canvas) return;
                
                const rect = canvas.parentElement.getBoundingClientRect();
                if (rect.width === 0) return;
                
                canvas.width = rect.width;
                canvas.height = canvas.classList.contains('initials') ? 70 : 100;
                
                const ctx = canvas.getContext('2d');
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                padContexts[id] = { canvas, ctx, isDrawing: false, lastX: 0, lastY: 0 };
                
                // Remove old listeners and add new ones
                canvas.replaceWith(canvas.cloneNode(true));
                const newCanvas = document.getElementById(id);
                padContexts[id].canvas = newCanvas;
                padContexts[id].ctx = newCanvas.getContext('2d');
                padContexts[id].ctx.strokeStyle = '#000000';
                padContexts[id].ctx.lineWidth = 2;
                padContexts[id].ctx.lineCap = 'round';
                padContexts[id].ctx.lineJoin = 'round';
                
                attachPadListeners(id);
            });
        }

        function attachPadListeners(id) {
            const pad = padContexts[id];
            if (!pad) return;
            
            const canvas = pad.canvas;
            
            function getCoords(e) {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.clientX ?? e.touches?.[0]?.clientX;
                const clientY = e.clientY ?? e.touches?.[0]?.clientY;
                return [clientX - rect.left, clientY - rect.top];
            }

            function start(e) {
                e.preventDefault();
                pad.isDrawing = true;
                [pad.lastX, pad.lastY] = getCoords(e);
            }

            function draw(e) {
                if (!pad.isDrawing) return;
                e.preventDefault();
                const [x, y] = getCoords(e);
                pad.ctx.beginPath();
                pad.ctx.moveTo(pad.lastX, pad.lastY);
                pad.ctx.lineTo(x, y);
                pad.ctx.stroke();
                [pad.lastX, pad.lastY] = [x, y];
            }

            function stop() {
                pad.isDrawing = false;
            }

            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stop);
            canvas.addEventListener('mouseleave', stop);
            canvas.addEventListener('touchstart', start, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', stop);
        }

        function setupMobilePadButtons(canvasId, clearId, saveId, type) {
            document.getElementById(clearId).onclick = () => {
                const pad = padContexts[canvasId];
                if (pad) pad.ctx.clearRect(0, 0, pad.canvas.width, pad.canvas.height);
            };

            document.getElementById(saveId).onclick = () => {
                const pad = padContexts[canvasId];
                if (!pad) { showToast('Draw something first!'); return; }
                
                const data = pad.ctx.getImageData(0, 0, pad.canvas.width, pad.canvas.height);
                if (!data.data.some((ch, i) => i % 4 === 3 && ch !== 0)) {
                    showToast('Please draw first!');
                    return;
                }
                
                const dataUrl = pad.canvas.toDataURL();
                if (type === 'signature') {
                    signatures.push(dataUrl);
                    localStorage.setItem('ctSignatures', JSON.stringify(signatures));
                    renderSignatures();
                } else {
                    initials.push(dataUrl);
                    localStorage.setItem('ctInitials', JSON.stringify(initials));
                    renderInitials();
                }
                pad.ctx.clearRect(0, 0, pad.canvas.width, pad.canvas.height);
                showToast('Saved! Tap it to use.');
            };
        }

        function setupPad(canvasId, clearId, saveId, widthId, colorId, type) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            let isDrawing = false, lastX = 0, lastY = 0;

            function initCanvas() {
                const rect = canvas.parentElement.getBoundingClientRect();
                if (rect.width === 0) return;
                canvas.width = rect.width;
                canvas.height = canvas.classList.contains('initials') ? 70 : 100;
                const ctx = canvas.getContext('2d');
                ctx.strokeStyle = colorId ? document.getElementById(colorId).value : '#000000';
                ctx.lineWidth = widthId ? document.getElementById(widthId).value : 2;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
            }

            initCanvas();
            window.addEventListener('resize', initCanvas);

            if (widthId) {
                document.getElementById(widthId).oninput = e => {
                    canvas.getContext('2d').lineWidth = e.target.value;
                };
            }
            if (colorId) {
                document.getElementById(colorId).oninput = e => {
                    canvas.getContext('2d').strokeStyle = e.target.value;
                };
            }

            function getCoords(e) {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.clientX ?? e.touches?.[0]?.clientX;
                const clientY = e.clientY ?? e.touches?.[0]?.clientY;
                return [clientX - rect.left, clientY - rect.top];
            }

            function start(e) {
                e.preventDefault();
                isDrawing = true;
                [lastX, lastY] = getCoords(e);
            }

            function draw(e) {
                if (!isDrawing) return;
                e.preventDefault();
                const ctx = canvas.getContext('2d');
                const [x, y] = getCoords(e);
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
                [lastX, lastY] = [x, y];
            }

            function stop() { isDrawing = false; }

            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stop);
            canvas.addEventListener('mouseleave', stop);
            canvas.addEventListener('touchstart', start, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', stop);

            document.getElementById(clearId).onclick = () => {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            };

            document.getElementById(saveId).onclick = () => {
                const ctx = canvas.getContext('2d');
                const data = ctx.getImageData(0, 0, canvas.width, canvas.height);
                if (!data.data.some((ch, i) => i % 4 === 3 && ch !== 0)) {
                    showToast('Please draw first!');
                    return;
                }
                const dataUrl = canvas.toDataURL();
                if (type === 'signature') {
                    signatures.push(dataUrl);
                    localStorage.setItem('ctSignatures', JSON.stringify(signatures));
                    renderSignatures();
                } else {
                    initials.push(dataUrl);
                    localStorage.setItem('ctInitials', JSON.stringify(initials));
                    renderInitials();
                }
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                showToast('Saved! Click it to use.');
            };
        }

        function clearSelections() {
            selectedSignature = null;
            selectedInitials = null;
            renderSignatures();
            renderInitials();
        }

        function renderSignatures() {
            ['sig-list', 'm-sig-list'].forEach(id => {
                const list = document.getElementById(id);
                if (!list) return;
                if (signatures.length === 0) {
                    list.innerHTML = '<p class="empty-state">No signatures saved yet</p>';
                    return;
                }
                list.innerHTML = signatures.map((sig, i) => `
                    <div class="saved-item ${selectedSignature === i ? 'selected' : ''}" data-index="${i}" data-type="signature">
                        <img src="${sig}" alt="Sig">
                        <button class="delete-btn" data-index="${i}" data-type="signature">√ó</button>
                    </div>
                `).join('');

                list.querySelectorAll('.saved-item').forEach(el => {
                    el.onclick = e => {
                        if (e.target.classList.contains('delete-btn')) return;
                        const idx = parseInt(el.dataset.index);
                        selectedSignature = selectedSignature === idx ? null : idx;
                        selectedInitials = null;
                        currentTool = 'signature';
                        renderSignatures();
                        renderInitials();
                        closeAllSheets();
                        if (selectedSignature !== null) showToast('Tap on PDF to place signature');
                    };
                });

                list.querySelectorAll('.delete-btn').forEach(el => {
                    el.onclick = e => {
                        e.stopPropagation();
                        signatures.splice(parseInt(el.dataset.index), 1);
                        localStorage.setItem('ctSignatures', JSON.stringify(signatures));
                        if (selectedSignature === parseInt(el.dataset.index)) selectedSignature = null;
                        renderSignatures();
                    };
                });
            });
        }

        function renderInitials() {
            ['initials-list', 'm-initials-list'].forEach(id => {
                const list = document.getElementById(id);
                if (!list) return;
                if (initials.length === 0) {
                    list.innerHTML = '<p class="empty-state">No initials saved yet</p>';
                    return;
                }
                list.innerHTML = initials.map((sig, i) => `
                    <div class="saved-item ${selectedInitials === i ? 'selected' : ''}" data-index="${i}" data-type="initials">
                        <img src="${sig}" alt="Init">
                        <button class="delete-btn" data-index="${i}" data-type="initials">√ó</button>
                    </div>
                `).join('');

                list.querySelectorAll('.saved-item').forEach(el => {
                    el.onclick = e => {
                        if (e.target.classList.contains('delete-btn')) return;
                        const idx = parseInt(el.dataset.index);
                        selectedInitials = selectedInitials === idx ? null : idx;
                        selectedSignature = null;
                        currentTool = 'initials';
                        renderSignatures();
                        renderInitials();
                        closeAllSheets();
                        if (selectedInitials !== null) showToast('Tap on PDF to place initials');
                    };
                });

                list.querySelectorAll('.delete-btn').forEach(el => {
                    el.onclick = e => {
                        e.stopPropagation();
                        initials.splice(parseInt(el.dataset.index), 1);
                        localStorage.setItem('ctInitials', JSON.stringify(initials));
                        if (selectedInitials === parseInt(el.dataset.index)) selectedInitials = null;
                        renderInitials();
                    };
                });
            });
        }

        // ========== TEXT ==========
        function addText(text, sizeEl, colorEl) {
            if (!text) { showToast('Enter text first'); return; }
            if (!pdfDoc) { showToast('Upload a PDF first'); return; }
            const canvasWidth = pdfCanvas.width / scale;
            const canvasHeight = pdfCanvas.height / scale;
            placedElements.push({
                type: 'text', page: currentPage,
                x: canvasWidth / 4, y: canvasHeight / 2,
                data: text,
                font: document.getElementById('text-font')?.value || 'Helvetica',
                size: parseInt(sizeEl.value),
                color: colorEl.value
            });
            renderOverlays();
            showToast('Text added! Drag to position.');
        }

        document.getElementById('add-text-btn').onclick = () => {
            const input = document.getElementById('text-input');
            addText(input.value.trim(), document.getElementById('text-size'), document.getElementById('text-color'));
            input.value = '';
        };

        document.getElementById('m-add-text-btn').onclick = () => {
            const input = document.getElementById('m-text-input');
            addText(input.value.trim(), document.getElementById('m-text-size'), document.getElementById('m-text-color'));
            input.value = '';
            closeAllSheets();
        };

        document.querySelectorAll('.quick-tool[data-text]').forEach(btn => {
            btn.onclick = () => {
                if (!pdfDoc) { showToast('Upload a PDF first'); return; }
                const isMobileBtn = btn.classList.contains('m-quick');
                const sizeEl = isMobileBtn ? document.getElementById('m-text-size') : document.getElementById('text-size');
                const colorEl = isMobileBtn ? document.getElementById('m-text-color') : document.getElementById('text-color');
                addText(btn.dataset.text, sizeEl, colorEl);
                closeAllSheets();
            };
        });

        // ========== CLEAR ACTIONS ==========
        ['clear-page-btn', 'm-clear-page-btn'].forEach(id => {
            document.getElementById(id).onclick = () => {
                if (!pdfDoc) return;
                placedElements = placedElements.filter(el => el.page !== currentPage);
                renderOverlays();
                closeAllSheets();
                showToast('Page cleared');
            };
        });

        ['clear-all-btn', 'm-clear-all-btn'].forEach(id => {
            document.getElementById(id).onclick = () => {
                if (!pdfDoc) return;
                if (confirm('Clear all elements from all pages?')) {
                    placedElements = [];
                    renderOverlays();
                    closeAllSheets();
                    showToast('All cleared');
                }
            };
        });

        // ========== FILE UPLOAD ==========
        document.getElementById('upload-btn').onclick = () => document.getElementById('file-input').click();
        document.getElementById('change-file-btn').onclick = () => document.getElementById('file-input').click();

        document.getElementById('file-input').onchange = async e => {
            const file = e.target.files[0];
            if (!file) return;
            try {
                const arrayBuffer = await file.arrayBuffer();
                pdfBytes = new Uint8Array(arrayBuffer.slice(0));
                pdfDoc = await pdfjsLib.getDocument({ data: pdfBytes.slice(0) }).promise;
                totalPages = pdfDoc.numPages;
                currentPage = 1;
                placedElements = [];
                textEdits = [];
                textItems = [];

                document.getElementById('total-pages').textContent = totalPages;
                uploadScreen.classList.add('hidden');
                pdfViewer.classList.add('active');
                sidebar.classList.add('active');
                mobileToolbar.classList.add('active');
                document.getElementById('download-btn').disabled = false;
                document.getElementById('change-file-btn').style.display = '';
                renderPage();
            } catch (err) {
                console.error(err);
                showToast('Error loading PDF');
            }
        };

        // ========== RENDER PAGE ==========
        async function renderPage() {
            const page = await pdfDoc.getPage(currentPage);
            const viewport = page.getViewport({ scale });
            pdfCanvas.width = viewport.width;
            pdfCanvas.height = viewport.height;
            await page.render({ canvasContext: pdfCanvas.getContext('2d'), viewport }).promise;

            document.getElementById('current-page').textContent = currentPage;
            document.getElementById('prev-page').disabled = currentPage <= 1;
            document.getElementById('next-page').disabled = currentPage >= totalPages;

            // Extract text for editing
            if (!textItems[currentPage]) {
                const textContent = await page.getTextContent();
                textItems[currentPage] = textContent.items.map((item, index) => {
                    const tx = pdfjsLib.Util.transform(viewport.transform, item.transform);
                    return {
                        index, str: item.str,
                        x: tx[4], y: tx[5] - item.height * scale,
                        width: item.width * scale, height: item.height * scale,
                        transform: item.transform
                    };
                });
            }

            renderOverlays();
            renderTextLayer();
        }

        // ========== RENDER OVERLAYS ==========
        function renderOverlays() {
            document.querySelectorAll('.element-overlay').forEach(el => el.remove());

            placedElements.forEach((el, idx) => {
                if (el.page !== currentPage) return;

                const overlay = document.createElement('div');
                overlay.className = 'element-overlay ' + el.type + '-el';
                overlay.dataset.idx = idx;
                overlay.style.left = (el.x * scale) + 'px';
                overlay.style.top = (el.y * scale) + 'px';

                if (el.type === 'signature' || el.type === 'initials') {
                    overlay.innerHTML = `
                        <img src="${el.dataUrl}" style="width:${el.width * scale}px;" draggable="false">
                        <div class="el-controls"><button class="el-remove" data-index="${idx}">√ó</button></div>
                        <div class="resize-handle" data-index="${idx}"></div>
                    `;
                } else if (el.type === 'text' || el.type === 'date') {
                    overlay.style.fontSize = (el.size * scale) + 'px';
                    overlay.style.color = el.color;
                    overlay.style.fontFamily = el.font === 'Courier' ? 'monospace' : el.font === 'Times-Roman' ? 'serif' : 'sans-serif';
                    overlay.innerHTML = `<span>${el.data}</span><div class="el-controls"><button class="el-remove" data-index="${idx}">√ó</button></div><div class="resize-handle" data-index="${idx}" data-type="text"></div>`;
                } else if (el.type === 'checkbox') {
                    overlay.style.fontSize = (el.size * scale) + 'px';
                    overlay.innerHTML = `${el.data}<div class="el-controls"><button class="el-remove" data-index="${idx}">√ó</button></div>`;
                }

                // Remove button
                overlay.querySelector('.el-remove')?.addEventListener('click', e => {
                    e.stopPropagation();
                    placedElements.splice(idx, 1);
                    renderOverlays();
                });

                // Resize handle
                const resizeHandle = overlay.querySelector('.resize-handle');
                if (resizeHandle) {
                    resizeHandle.addEventListener('mousedown', startResize);
                    resizeHandle.addEventListener('touchstart', startResize, { passive: false });

                    function startResize(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        const startX = e.clientX || e.touches?.[0]?.clientX;
                        const startY = e.clientY || e.touches?.[0]?.clientY;
                        const isText = resizeHandle.dataset.type === 'text';

                        if (isText) {
                            const origSize = el.size;
                            const onResize = ev => {
                                const clientX = ev.clientX || ev.touches?.[0]?.clientX;
                                const clientY = ev.clientY || ev.touches?.[0]?.clientY;
                                const delta = (clientX - startX + clientY - startY) / 2;
                                el.size = Math.max(8, Math.min(72, origSize + delta / scale));
                                overlay.style.fontSize = (el.size * scale) + 'px';
                            };
                            const stopResize = () => {
                                document.removeEventListener('mousemove', onResize);
                                document.removeEventListener('mouseup', stopResize);
                                document.removeEventListener('touchmove', onResize);
                                document.removeEventListener('touchend', stopResize);
                            };
                            document.addEventListener('mousemove', onResize);
                            document.addEventListener('mouseup', stopResize);
                            document.addEventListener('touchmove', onResize, { passive: false });
                            document.addEventListener('touchend', stopResize);
                        } else {
                            const origW = el.width;
                            const onResize = ev => {
                                const clientX = ev.clientX || ev.touches?.[0]?.clientX;
                                el.width = Math.max(50, origW + (clientX - startX) / scale);
                                el.height = el.width * 0.33;
                                overlay.querySelector('img').style.width = (el.width * scale) + 'px';
                            };
                            const stopResize = () => {
                                document.removeEventListener('mousemove', onResize);
                                document.removeEventListener('mouseup', stopResize);
                                document.removeEventListener('touchmove', onResize);
                                document.removeEventListener('touchend', stopResize);
                            };
                            document.addEventListener('mousemove', onResize);
                            document.addEventListener('mouseup', stopResize);
                            document.addEventListener('touchmove', onResize, { passive: false });
                            document.addEventListener('touchend', stopResize);
                        }
                    }
                }

                // Drag - setup
                let isDragging = false, startX, startY, origX, origY;

                function startDrag(e) {
                    if (e.target.classList.contains('el-remove') || e.target.classList.contains('resize-handle')) return;
                    e.preventDefault();
                    isDragging = true;
                    startX = e.clientX || e.touches?.[0]?.clientX;
                    startY = e.clientY || e.touches?.[0]?.clientY;
                    origX = parseFloat(overlay.style.left);
                    origY = parseFloat(overlay.style.top);
                    overlay.style.zIndex = '100';
                    overlay.style.opacity = '0.85';
                }

                function doDrag(e) {
                    if (!isDragging) return;
                    e.preventDefault();
                    const clientX = e.clientX || e.touches?.[0]?.clientX;
                    const clientY = e.clientY || e.touches?.[0]?.clientY;
                    let newX = origX + clientX - startX;
                    let newY = origY + clientY - startY;
                    newX = Math.max(0, Math.min(newX, pdfCanvas.width - 30));
                    newY = Math.max(0, Math.min(newY, pdfCanvas.height - 20));
                    overlay.style.left = newX + 'px';
                    overlay.style.top = newY + 'px';
                    el.x = newX / scale;
                    el.y = newY / scale;
                }

                function stopDrag() {
                    if (isDragging) {
                        isDragging = false;
                        overlay.style.zIndex = '';
                        overlay.style.opacity = '';
                    }
                }

                overlay.addEventListener('mousedown', startDrag);
                overlay.addEventListener('touchstart', startDrag, { passive: false });
                document.addEventListener('mousemove', doDrag);
                document.addEventListener('touchmove', doDrag, { passive: false });
                document.addEventListener('mouseup', stopDrag);
                document.addEventListener('touchend', stopDrag);

                pdfWrapper.appendChild(overlay);
            });
        }

        // ========== TEXT LAYER ==========
        function renderTextLayer() {
            textLayer.innerHTML = '';
            if (!textItems[currentPage]) return;

            textLayer.style.width = pdfCanvas.width + 'px';
            textLayer.style.height = pdfCanvas.height + 'px';

            textItems[currentPage].forEach((item, index) => {
                if (!item.str.trim()) return;

                const div = document.createElement('div');
                div.className = 'text-item';
                div.dataset.index = index;

                const edit = textEdits.find(e => e.page === currentPage && e.index === index);
                if (edit) {
                    div.classList.add('modified');
                    div.textContent = edit.newText;
                } else {
                    div.textContent = item.str;
                }

                div.style.left = item.x + 'px';
                div.style.top = item.y + 'px';
                div.style.fontSize = (item.height * 0.85) + 'px';
                div.style.height = item.height + 'px';
                div.style.lineHeight = item.height + 'px';
                div.style.minWidth = (item.width || 10) + 'px';

                div.onclick = () => openEditModal(item, index);
                textLayer.appendChild(div);
            });
        }

        function openEditModal(item, index) {
            currentEditItem = { item, index, page: currentPage };
            const existingEdit = textEdits.find(e => e.page === currentPage && e.index === index);
            document.getElementById('edit-input').value = existingEdit ? existingEdit.newText : item.str;
            document.getElementById('original-text').textContent = item.str;
            editModal.classList.add('active');
            document.getElementById('edit-input').focus();
        }

        document.getElementById('edit-cancel').onclick = () => {
            editModal.classList.remove('active');
            currentEditItem = null;
        };

        document.getElementById('edit-apply').onclick = applyTextEdit;
        document.getElementById('edit-input').onkeydown = e => {
            if (e.key === 'Enter') applyTextEdit();
            if (e.key === 'Escape') { editModal.classList.remove('active'); currentEditItem = null; }
        };

        editModal.onclick = e => {
            if (e.target === editModal) { editModal.classList.remove('active'); currentEditItem = null; }
        };

        function applyTextEdit() {
            if (!currentEditItem) return;
            const { item, index, page } = currentEditItem;
            const newText = document.getElementById('edit-input').value;

            textEdits = textEdits.filter(e => !(e.page === page && e.index === index));
            if (newText !== item.str) {
                textEdits.push({ page, index, original: item.str, newText, item });
            }

            editModal.classList.remove('active');
            currentEditItem = null;
            renderTextLayer();
            updateEditList();
            showToast('Text updated');
        }

        function updateEditList() {
            const list = document.getElementById('edit-list');
            const countEl = document.getElementById('edit-count');
            if (countEl) countEl.textContent = textEdits.length;

            if (!list) return;
            if (textEdits.length === 0) {
                list.innerHTML = '<p class="empty-state">No text edits yet</p>';
                return;
            }

            list.innerHTML = textEdits.map((edit, i) => `
                <div class="edit-item">
                    <div class="edit-item-header">
                        <span class="edit-item-page">Page ${edit.page}</span>
                        <button class="edit-item-remove" data-index="${i}">√ó</button>
                    </div>
                    <div class="edit-item-original">${escapeHtml(edit.original)}</div>
                    <div class="edit-item-new">${escapeHtml(edit.newText)}</div>
                </div>
            `).join('');

            list.querySelectorAll('.edit-item-remove').forEach(btn => {
                btn.onclick = () => {
                    textEdits.splice(parseInt(btn.dataset.index), 1);
                    renderTextLayer();
                    updateEditList();
                };
            });
        }

        function escapeHtml(str) {
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        // ========== FIND & REPLACE ==========
        async function doFindReplace(findId, replaceId) {
            const findText = document.getElementById(findId).value;
            const replaceText = document.getElementById(replaceId).value;
            if (!findText) { showToast('Enter text to find'); return; }

            // Load all pages' text
            for (let p = 1; p <= totalPages; p++) {
                if (!textItems[p]) {
                    const page = await pdfDoc.getPage(p);
                    const viewport = page.getViewport({ scale });
                    const textContent = await page.getTextContent();
                    textItems[p] = textContent.items.map((item, index) => ({
                        index, str: item.str, transform: item.transform, width: item.width, height: item.height
                    }));
                }
            }

            let count = 0;
            for (let page = 1; page <= totalPages; page++) {
                textItems[page].forEach((item, index) => {
                    if (item.str.includes(findText)) {
                        textEdits = textEdits.filter(e => !(e.page === page && e.index === index));
                        const newText = item.str.split(findText).join(replaceText);
                        if (newText !== item.str) {
                            textEdits.push({ page, index, original: item.str, newText, item });
                            count++;
                        }
                    }
                });
            }

            showToast(count > 0 ? `Replaced ${count} occurrence(s)` : 'No matches found');
            renderTextLayer();
            updateEditList();
            closeAllSheets();
        }

        document.getElementById('replace-all-btn').onclick = () => doFindReplace('find-input', 'replace-input');
        document.getElementById('m-replace-all-btn').onclick = () => doFindReplace('m-find-input', 'm-replace-input');

        // ========== CANVAS CLICK ==========
        pdfCanvas.onclick = e => {
            const rect = pdfCanvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) / scale;
            const y = (e.clientY - rect.top) / scale;

            if (currentTool === 'signature' && selectedSignature !== null) {
                placedElements.push({ type: 'signature', page: currentPage, x, y, width: 150, height: 50, dataUrl: signatures[selectedSignature] });
                showToast('Signature placed!');
            } else if (currentTool === 'initials' && selectedInitials !== null) {
                placedElements.push({ type: 'initials', page: currentPage, x, y, width: 60, height: 40, dataUrl: initials[selectedInitials] });
                showToast('Initials placed!');
            } else if (currentTool === 'date' && selectedDateFormat !== null) {
                placedElements.push({
                    type: 'date', page: currentPage, x, y,
                    data: dateFormats[selectedDateFormat].fn(),
                    font: document.getElementById('date-font')?.value || 'Helvetica',
                    size: parseInt(document.getElementById('date-size')?.value || 12),
                    color: document.getElementById('date-color')?.value || '#000000'
                });
                showToast('Date placed!');
            } else if (currentTool === 'checkbox') {
                placedElements.push({ type: 'checkbox', page: currentPage, x, y, data: selectedCheckboxStyle, size: 16, color: '#000000' });
                showToast('Checkbox placed!');
            } else {
                return;
            }

            renderOverlays();
        };

        // ========== PAGE NAV ==========
        document.getElementById('prev-page').onclick = () => { if (currentPage > 1) { currentPage--; renderPage(); } };
        document.getElementById('next-page').onclick = () => { if (currentPage < totalPages) { currentPage++; renderPage(); } };

        // ========== ZOOM ==========
        document.getElementById('zoom-in').onclick = () => {
            scale = Math.min(scale + 0.25, 3);
            document.getElementById('zoom-level').textContent = Math.round(scale * 100) + '%';
            renderPage();
        };
        document.getElementById('zoom-out').onclick = () => {
            scale = Math.max(scale - 0.25, 0.25);
            document.getElementById('zoom-level').textContent = Math.round(scale * 100) + '%';
            renderPage();
        };
        document.getElementById('zoom-fit').onclick = async () => {
            if (!pdfDoc) return;
            const page = await pdfDoc.getPage(currentPage);
            const viewport = page.getViewport({ scale: 1 });
            const containerWidth = pdfViewer.clientWidth - 30; // account for padding
            scale = containerWidth / viewport.width;
            scale = Math.max(0.25, Math.min(scale, 2)); // clamp between 25% and 200%
            document.getElementById('zoom-level').textContent = Math.round(scale * 100) + '%';
            renderPage();
        };

        // ========== DOWNLOAD ==========
        document.getElementById('download-btn').onclick = async () => {
            if (!pdfBytes) return;
            if (placedElements.length === 0 && textEdits.length === 0) {
                showToast('No changes to save');
                return;
            }

            try {
                const { PDFDocument, rgb, StandardFonts } = PDFLib;
                const doc = await PDFDocument.load(pdfBytes.slice(0));
                const helvetica = await doc.embedFont(StandardFonts.Helvetica);
                const pages = doc.getPages();

                // Apply placed elements
                for (const el of placedElements) {
                    const page = pages[el.page - 1];
                    const { width, height } = page.getSize();

                    if (el.type === 'signature' || el.type === 'initials') {
                        const base64 = el.dataUrl.split(',')[1];
                        const imgBytes = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
                        const img = await doc.embedPng(imgBytes);
                        const dims = img.scale(el.width / img.width);
                        page.drawImage(img, { x: el.x, y: height - el.y - dims.height, width: dims.width, height: dims.height });
                    } else if (el.type === 'text' || el.type === 'date') {
                        const fontMap = { 'Helvetica': StandardFonts.Helvetica, 'Times-Roman': StandardFonts.TimesRoman, 'Courier': StandardFonts.Courier };
                        const font = await doc.embedFont(fontMap[el.font] || StandardFonts.Helvetica);
                        const hex = el.color.replace('#', '');
                        const r = parseInt(hex.substr(0, 2), 16) / 255;
                        const g = parseInt(hex.substr(2, 2), 16) / 255;
                        const b = parseInt(hex.substr(4, 2), 16) / 255;
                        page.drawText(el.data, { x: el.x, y: height - el.y - el.size, size: el.size, font, color: rgb(r, g, b) });
                    } else if (el.type === 'checkbox') {
                        const size = el.size;
                        const x = el.x;
                        const y = height - el.y - size;

                        if (el.data === '‚úì') {
                            page.drawLine({ start: { x: x + 2, y: y + size/2 }, end: { x: x + size/3, y: y + 3 }, thickness: 2, color: rgb(0, 0, 0) });
                            page.drawLine({ start: { x: x + size/3, y: y + 3 }, end: { x: x + size - 2, y: y + size - 3 }, thickness: 2, color: rgb(0, 0, 0) });
                        } else if (el.data === '‚úó') {
                            page.drawLine({ start: { x: x + 2, y: y + 2 }, end: { x: x + size - 2, y: y + size - 2 }, thickness: 2, color: rgb(0, 0, 0) });
                            page.drawLine({ start: { x: x + size - 2, y: y + 2 }, end: { x: x + 2, y: y + size - 2 }, thickness: 2, color: rgb(0, 0, 0) });
                        } else if (el.data === '‚óè') {
                            page.drawCircle({ x: x + size/2, y: y + size/2, size: size/2 - 1, color: rgb(0, 0, 0) });
                        } else if (el.data === '‚òê') {
                            page.drawRectangle({ x, y, width: size, height: size, borderColor: rgb(0, 0, 0), borderWidth: 1.5 });
                        } else if (el.data === '‚òë') {
                            page.drawRectangle({ x, y, width: size, height: size, borderColor: rgb(0, 0, 0), borderWidth: 1.5 });
                            page.drawLine({ start: { x: x + 3, y: y + size/2 }, end: { x: x + size/3, y: y + 3 }, thickness: 1.5, color: rgb(0, 0, 0) });
                            page.drawLine({ start: { x: x + size/3, y: y + 3 }, end: { x: x + size - 3, y: y + size - 3 }, thickness: 1.5, color: rgb(0, 0, 0) });
                        }
                    }
                }

                // Apply text edits
                for (const edit of textEdits) {
                    const page = pages[edit.page - 1];
                    const { height } = page.getSize();
                    const item = edit.item;
                    const x = item.transform[4];
                    const y = item.transform[5];
                    const fontSize = Math.abs(item.transform[3]) || 12;

                    const textWidth = helvetica.widthOfTextAtSize(edit.original, fontSize);
                    page.drawRectangle({ x: x - 1, y: y - 2, width: textWidth + 4, height: fontSize + 4, color: rgb(1, 1, 1) });
                    page.drawText(edit.newText, { x, y, size: fontSize, font: helvetica, color: rgb(0, 0, 0) });
                }

                const editedBytes = await doc.save();
                const blob = new Blob([editedBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'edited-document.pdf';
                a.click();
                URL.revokeObjectURL(url);
                showToast('PDF saved!');

            } catch (err) {
                console.error(err);
                showToast('Error: ' + err.message);
            }
        };

        // ========== TOAST ==========
        function showToast(msg) {
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        // ========== RESIZE ==========
        window.addEventListener('resize', () => {
            isMobile = window.innerWidth < 768;
            if (pdfDoc) renderPage();
        });

        // ========== START ==========
        init();
    </script>
</body>
</html>
