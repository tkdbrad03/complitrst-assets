<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Signer & Editor Pro | CompliTrst‚Ñ¢</title>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --teal: #0D6B58;
            --teal-dark: #0A5647;
            --teal-light: #0E7D66;
            --gold: #C9A227;
            --gold-light: #D4B03A;
            --gold-dark: #B8921F;
            --bg-main: #FFFFFF;
            --bg-card: #F8F9FA;
            --text-dark: #1A1A1A;
            --text-muted: #6B7280;
            --border-light: #E5E7EB;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-main);
            min-height: 100vh;
            color: var(--text-dark);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 20px 0;
        }

        header h1 {
            font-size: 2.2rem;
            background: linear-gradient(90deg, var(--gold-dark), var(--gold), var(--gold-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        header p {
            color: var(--text-muted);
            font-size: 1rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 20px;
            margin-top: 15px;
        }

        @media (max-width: 1000px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border-light);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .panel h2 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: var(--teal);
        }

        .panel h3 {
            font-size: 0.95rem;
            margin: 15px 0 10px 0;
            color: var(--text-muted);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 10px;
        }

        .tab {
            padding: 10px 16px;
            background: #fff;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .tab:hover {
            background: rgba(13, 107, 88, 0.05);
            border-color: var(--teal);
        }

        .tab.active {
            background: rgba(201, 162, 39, 0.1);
            border-color: var(--gold);
            color: var(--gold-dark);
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Upload Zone */
        .upload-zone {
            border: 2px dashed var(--gold);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            background: rgba(201, 162, 39, 0.03);
        }

        .upload-zone:hover, .upload-zone.drag-over {
            border-color: var(--gold-dark);
            background: rgba(201, 162, 39, 0.08);
        }

        .upload-zone.has-file {
            padding: 15px;
            border-style: solid;
            border-color: var(--teal);
            background: rgba(13, 107, 88, 0.05);
        }

        .upload-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .upload-zone p {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .file-name {
            color: var(--teal);
            font-weight: 600;
            word-break: break-all;
        }

        /* PDF Preview */
        .pdf-preview-container {
            position: relative;
            background: #fff;
            border-radius: 8px;
            overflow: visible;
            min-height: 600px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--border-light);
        }

        #pdf-preview {
            max-width: 100%;
            cursor: crosshair;
        }

        /* Overlay container - positioned over canvas */
        .overlay-container {
            position: absolute;
            pointer-events: none;
            border: 2px solid red; /* DEBUG - remove later */
            z-index: 50;
        }

        .overlay-container .element-overlay {
            pointer-events: auto;
            z-index: 100;
        }

        /* Text Layer - always active */
        .text-layer {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        .text-item {
            position: absolute;
            cursor: text;
            pointer-events: auto;
            border: 1px solid transparent;
            transition: all 0.2s;
            white-space: pre;
            color: transparent;
            background: transparent;
        }

        .text-item:hover {
            background: rgba(201, 162, 39, 0.25);
            border-color: var(--gold);
            border-style: dashed;
        }

        .text-item.modified {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #4CAF50;
            color: #000;
        }

        /* Overlays for Sign Mode */
        .element-overlay {
            position: absolute;
            cursor: move;
            border: 2px dashed var(--teal);
            background: rgba(255, 255, 255, 0.95);
            user-select: none;
            touch-action: none;
            z-index: 100;
        }

        .element-overlay:active {
            cursor: grabbing;
            opacity: 0.9;
        }

        .element-overlay.signature-el {
            padding: 5px;
        }

        .element-overlay.text-el {
            padding: 4px 10px;
            font-family: inherit;
            min-width: 50px;
            position: relative;
            background: rgba(255, 255, 255, 0.95);
            border: 2px dashed var(--teal);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .element-overlay.date-el {
            padding: 4px 10px;
            font-weight: 500;
            position: relative;
        }

        .element-overlay.initials-el {
            padding: 5px;
        }

        .element-overlay.checkbox-el {
            padding: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            min-width: 24px;
            min-height: 24px;
            position: relative;
        }

        .element-overlay img {
            display: block;
            pointer-events: none;
        }

        .element-controls {
            position: absolute;
            top: -32px;
            right: 0;
            display: flex;
            gap: 3px;
        }

        .element-controls button {
            width: 26px;
            height: 26px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .el-remove {
            background: #C0392B;
            color: #fff;
        }

        .resize-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--gold);
            border: 2px solid #fff;
            border-radius: 2px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .resize-handle.se {
            bottom: -6px;
            right: -6px;
            cursor: se-resize;
        }

        /* Page Navigation */
        .page-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .page-nav button {
            background: #fff;
            border: 1px solid var(--teal);
            color: var(--teal);
            padding: 6px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .page-nav button:hover:not(:disabled) {
            background: var(--teal);
            color: #fff;
        }

        .page-nav button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .page-info {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .zoom-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .zoom-controls button {
            background: #fff;
            border: 1px solid var(--gold);
            color: var(--gold-dark);
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .zoom-controls span {
            color: var(--text-muted);
            min-width: 50px;
            text-align: center;
            font-size: 0.85rem;
        }

        /* Signature Pad */
        .signature-pad-container {
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 10px;
            border: 2px solid var(--border-light);
        }

        #signature-pad, #initials-pad {
            width: 100%;
            height: 120px;
            cursor: crosshair;
        }

        #initials-pad {
            height: 80px;
        }

        .sig-controls {
            display: flex;
            gap: 8px;
        }

        .btn {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.85rem;
        }

        .btn-clear {
            background: #fff;
            color: #C0392B;
            border: 1px solid #C0392B;
        }

        .btn-clear:hover {
            background: #C0392B;
            color: #fff;
        }

        .btn-save {
            background: #fff;
            color: var(--teal);
            border: 1px solid var(--teal);
        }

        .btn-save:hover {
            background: var(--teal);
            color: #fff;
        }

        /* Saved Signatures */
        .signature-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .saved-sig {
            background: #fff;
            border-radius: 6px;
            padding: 8px;
            cursor: pointer;
            border: 2px solid var(--border-light);
            transition: all 0.3s;
            position: relative;
        }

        .saved-sig:hover {
            border-color: var(--gold);
        }

        .saved-sig.selected {
            border-color: var(--teal);
            box-shadow: 0 0 0 3px rgba(13, 107, 88, 0.2);
        }

        .saved-sig img {
            height: 35px;
            display: block;
        }

        .saved-sig .delete-sig {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 18px;
            height: 18px;
            background: #C0392B;
            border: none;
            border-radius: 50%;
            color: #fff;
            cursor: pointer;
            font-size: 10px;
            display: none;
        }

        .saved-sig:hover .delete-sig {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .empty-state {
            color: var(--text-muted);
            font-style: italic;
            font-size: 0.85rem;
        }

        /* Text Input Section */
        .text-input-section {
            margin-bottom: 15px;
        }

        .text-input-row {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .text-input-row input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            background: #fff;
            color: var(--text-dark);
            font-size: 0.9rem;
        }

        .text-input-row input:focus {
            outline: none;
            border-color: var(--teal);
        }

        .text-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .text-options select, .text-options input[type="color"] {
            padding: 8px;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            background: #fff;
            color: var(--text-dark);
            font-size: 0.85rem;
        }

        .text-options input[type="color"] {
            width: 40px;
            height: 36px;
            padding: 2px;
            cursor: pointer;
        }

        /* Date Format */
        .date-formats {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .date-format-btn {
            padding: 8px 12px;
            background: #fff;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
        }

        .date-format-btn:hover {
            border-color: var(--teal);
            color: var(--teal);
        }

        .date-format-btn.selected {
            background: rgba(201, 162, 39, 0.1);
            border-color: var(--gold);
            color: var(--gold-dark);
            font-weight: 600;
        }

        /* Quick Tools */
        .quick-tools {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .quick-tool {
            padding: 12px;
            background: #fff;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-size: 0.85rem;
        }

        .quick-tool:hover {
            background: rgba(201, 162, 39, 0.08);
            border-color: var(--gold);
            color: var(--gold-dark);
        }

        .quick-tool .icon {
            font-size: 1.3rem;
            margin-bottom: 4px;
        }

        /* Checkbox styles */
        .checkbox-options {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .checkbox-style {
            padding: 10px 15px;
            background: #fff;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.3s;
        }

        .checkbox-style:hover {
            border-color: var(--teal);
        }

        .checkbox-style.selected {
            background: rgba(201, 162, 39, 0.1);
            border-color: var(--gold);
        }

        /* Pen options */
        .pen-options {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .pen-options label {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .pen-options input[type="range"] {
            flex: 1;
            accent-color: var(--teal);
        }

        .pen-options input[type="color"] {
            width: 35px;
            height: 30px;
            padding: 0;
            border: 1px solid var(--border-light);
            border-radius: 4px;
            cursor: pointer;
        }

        /* Find & Replace */
        .find-replace {
            background: #fff;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .find-replace input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .find-replace input:focus {
            outline: none;
            border-color: var(--teal);
        }

        .find-replace button {
            width: 100%;
            padding: 10px;
            background: var(--teal);
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        /* Edit List */
        .edit-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .edit-item {
            background: #fff;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }

        .edit-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .edit-item-page {
            font-size: 0.75rem;
            color: var(--text-muted);
            background: var(--bg-card);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .edit-item-remove {
            background: none;
            border: none;
            color: #C0392B;
            cursor: pointer;
        }

        .edit-item-original {
            color: var(--text-muted);
            text-decoration: line-through;
            font-size: 0.8rem;
        }

        .edit-item-new {
            color: var(--teal);
            font-weight: 500;
        }

        /* Download Section */
        .download-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border-light);
        }

        .btn-download {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--gold-dark), var(--gold), var(--gold-light));
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .btn-download:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(201, 162, 39, 0.35);
        }

        .btn-download:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .element-count {
            text-align: center;
            margin-top: 10px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Right panel scroll */
        .right-panel {
            max-height: calc(100vh - 120px);
            overflow-y: auto;
        }

        .right-panel::-webkit-scrollbar {
            width: 6px;
        }

        .right-panel::-webkit-scrollbar-track {
            background: var(--bg-card);
            border-radius: 3px;
        }

        .right-panel::-webkit-scrollbar-thumb {
            background: var(--gold);
            border-radius: 3px;
        }

        /* Edit Modal */
        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .edit-modal.active {
            display: flex;
        }

        .edit-modal-content {
            background: #fff;
            border-radius: 16px;
            padding: 25px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .edit-modal h3 {
            margin-bottom: 15px;
            color: var(--teal);
        }

        .edit-modal input[type="text"] {
            width: 100%;
            padding: 12px;
            font-size: 1rem;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .edit-modal input:focus {
            outline: none;
            border-color: var(--teal);
        }

        .edit-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 15px;
        }

        .edit-modal-buttons button {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-cancel {
            background: #fff;
            border: 1px solid var(--border-light);
            color: var(--text-muted);
        }

        .btn-apply {
            background: var(--teal);
            border: none;
            color: #fff;
        }

        .brand-footer {
            text-align: center;
            padding: 20px;
            margin-top: 20px;
            color: var(--text-muted);
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="display:flex;align-items:center;justify-content:center;gap:15px;margin-bottom:8px;">
                <img src="https://github.com/tkdbrad03/complitrst-assets/blob/main/complitrst-logo_transparent.png?raw=true" alt="CompliTrst" style="height:60px;">
                <h1>PDF Signer & Editor Pro</h1>
            </div>
            <p>Powered by CompliTrst‚Ñ¢ ‚Ä¢ Sign, Edit, Own Your Documents</p>
        </header>

        <div class="main-content">
            <!-- Left Panel - PDF Preview -->
            <div class="panel">
                <h2>üìÑ Document Preview</h2>
                
                <div class="upload-zone" id="upload-zone">
                    <div class="upload-icon">üìÅ</div>
                    <p>Drag & drop a PDF here or click to browse</p>
                    <input type="file" id="file-input" accept=".pdf" hidden>
                </div>

                <div class="pdf-preview-container" id="preview-container" style="display: none;">
                    <canvas id="pdf-preview"></canvas>
                    <div class="overlay-container" id="overlay-container"></div>
                    <div class="text-layer" id="text-layer"></div>
                </div>

                <div class="page-nav" id="page-nav" style="display: none;">
                    <button id="prev-page">‚Üê Prev</button>
                    <span class="page-info">Page <span id="current-page">1</span> of <span id="total-pages">1</span></span>
                    <button id="next-page">Next ‚Üí</button>
                    <div class="zoom-controls">
                        <button id="zoom-out">‚àí</button>
                        <span id="zoom-level">100%</span>
                        <button id="zoom-in">+</button>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Tools -->
            <div class="panel right-panel">
                <div class="tabs">
                    <div class="tab active" data-tab="signature">‚úçÔ∏è Sign</div>
                    <div class="tab" data-tab="text">üìù Text</div>
                    <div class="tab" data-tab="date">üìÖ Date</div>
                    <div class="tab" data-tab="edit">‚úèÔ∏è Edit</div>
                    <div class="tab" data-tab="more">‚ûï More</div>
                </div>

                <!-- Signature Tab -->
                <div class="tab-content active" id="tab-signature">
                    <h3>Draw Your Signature</h3>
                    <div class="pen-options">
                        <label>Width:</label>
                        <input type="range" id="sig-pen-width" min="1" max="6" value="2">
                        <input type="color" id="sig-pen-color" value="#000000">
                    </div>
                    <div class="signature-pad-container">
                        <canvas id="signature-pad"></canvas>
                    </div>
                    <div class="sig-controls">
                        <button class="btn btn-clear" id="clear-sig">Clear</button>
                        <button class="btn btn-save" id="save-sig">Save</button>
                    </div>

                    <h3>Saved Signatures <span style="font-weight:normal;color:#999;">(click to select)</span></h3>
                    <div class="signature-list" id="signature-list">
                        <p class="empty-state">No signatures saved yet</p>
                    </div>

                    <h3>Draw Initials</h3>
                    <div class="signature-pad-container">
                        <canvas id="initials-pad"></canvas>
                    </div>
                    <div class="sig-controls">
                        <button class="btn btn-clear" id="clear-initials">Clear</button>
                        <button class="btn btn-save" id="save-initials">Save</button>
                    </div>

                    <h3>Saved Initials</h3>
                    <div class="signature-list" id="initials-list">
                        <p class="empty-state">No initials saved yet</p>
                    </div>
                </div>

                <!-- Text Tab -->
                <div class="tab-content" id="tab-text">
                    <h3>Add Text to Document</h3>
                    <div class="text-input-section">
                        <div class="text-input-row">
                            <input type="text" id="text-input" placeholder="Type your text here...">
                            <button class="btn btn-save" id="add-text-btn">Add</button>
                        </div>
                        <div class="text-options">
                            <select id="text-font">
                                <option value="Helvetica">Helvetica</option>
                                <option value="Times-Roman">Times</option>
                                <option value="Courier">Courier</option>
                            </select>
                            <select id="text-size">
                                <option value="10">10px</option>
                                <option value="12" selected>12px</option>
                                <option value="14">14px</option>
                                <option value="16">16px</option>
                                <option value="18">18px</option>
                                <option value="20">20px</option>
                                <option value="24">24px</option>
                            </select>
                            <input type="color" id="text-color" value="#000000">
                        </div>
                    </div>

                    <h3>Quick Text</h3>
                    <div class="quick-tools">
                        <div class="quick-tool" data-text="Approved">‚úì Approved</div>
                        <div class="quick-tool" data-text="Rejected">‚úó Rejected</div>
                        <div class="quick-tool" data-text="DRAFT">üìã DRAFT</div>
                        <div class="quick-tool" data-text="CONFIDENTIAL">üîí CONFIDENTIAL</div>
                    </div>
                </div>

                <!-- Date Tab -->
                <div class="tab-content" id="tab-date">
                    <h3>Add Date Stamp</h3>
                    <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:15px;">Click a format, then click on the PDF</p>
                    
                    <div class="date-formats" id="date-formats"></div>

                    <div class="text-options" style="margin-top:15px;">
                        <select id="date-font">
                            <option value="Helvetica">Helvetica</option>
                            <option value="Times-Roman">Times</option>
                            <option value="Courier">Courier</option>
                        </select>
                        <select id="date-size">
                            <option value="10">10px</option>
                            <option value="12" selected>12px</option>
                            <option value="14">14px</option>
                            <option value="16">16px</option>
                        </select>
                        <input type="color" id="date-color" value="#000000">
                    </div>
                </div>

                <!-- Edit Tab -->
                <div class="tab-content" id="tab-edit">
                    <div class="edit-instructions" style="background:rgba(201,162,39,0.1);border-radius:8px;padding:15px;margin-bottom:15px;">
                        <p style="color:var(--gold-dark);font-weight:600;margin-bottom:8px;">üí° How to Edit Text</p>
                        <p style="color:var(--text-muted);font-size:0.85rem;">Hover over any text in the PDF ‚Äî it will highlight. Click to edit it.</p>
                    </div>

                    <h3>Find & Replace</h3>
                    <div class="find-replace">
                        <input type="text" id="find-input" placeholder="Find text...">
                        <input type="text" id="replace-input" placeholder="Replace with...">
                        <button id="replace-all-btn">Replace All</button>
                    </div>

                    <h3>Text Edits <span style="font-weight:normal;color:#999;">(<span id="edit-count">0</span>)</span></h3>
                    <div class="edit-list" id="edit-list">
                        <p class="empty-state">No text edits yet</p>
                    </div>
                </div>

                <!-- More Tab -->
                <div class="tab-content" id="tab-more">
                    <h3>Checkboxes</h3>
                    <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:10px;">Select style, then click on PDF</p>
                    <div class="checkbox-options" id="checkbox-options">
                        <div class="checkbox-style selected" data-style="‚úì">‚úì</div>
                        <div class="checkbox-style" data-style="‚úó">‚úó</div>
                        <div class="checkbox-style" data-style="‚òë">‚òë</div>
                        <div class="checkbox-style" data-style="‚òê">‚òê</div>
                        <div class="checkbox-style" data-style="‚óè">‚óè</div>
                    </div>

                    <h3>Quick Actions</h3>
                    <div class="quick-tools">
                        <div class="quick-tool" id="clear-page-elements">
                            <div class="icon">üóëÔ∏è</div>
                            Clear Page
                        </div>
                        <div class="quick-tool" id="clear-all-elements">
                            <div class="icon">üóëÔ∏è</div>
                            Clear All
                        </div>
                    </div>
                </div>

                <!-- Download Section -->
                <div class="download-section">
                    <button class="btn-download" id="download-btn" disabled>
                        ‚¨áÔ∏è Download PDF
                    </button>
                    <div class="element-count" id="element-count">No changes yet</div>
                </div>
            </div>
        </div>

        <div class="brand-footer">
            A <strong>CompliTrst‚Ñ¢</strong> Tool ‚Ä¢ No Subscriptions. Full Ownership. <span style="opacity:0.5">v1.4</span>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="edit-modal" id="edit-modal">
        <div class="edit-modal-content">
            <h3>Edit Text</h3>
            <input type="text" id="edit-input" placeholder="Enter new text...">
            <p style="font-size: 0.85rem; color: var(--text-muted);">
                Original: <span id="original-text" style="font-style: italic;"></span>
            </p>
            <div class="edit-modal-buttons">
                <button class="btn-cancel" id="edit-cancel">Cancel</button>
                <button class="btn-apply" id="edit-apply">Apply</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js';

        // State
        let pdfDoc = null;
        let pdfBytes = null;
        let currentPage = 1;
        let totalPages = 0;
        let scale = 1.0;
        
        // Sign mode state
        let signatures = JSON.parse(localStorage.getItem('compliTrstSignatures') || '[]');
        let initials = JSON.parse(localStorage.getItem('compliTrstInitials') || '[]');
        let selectedSignature = null;
        let selectedInitials = null;
        let selectedDateFormat = null;
        let selectedCheckboxStyle = '‚úì';
        let currentTool = 'signature';
        let placedElements = [];

        // Edit mode state
        let textItems = [];
        let textEdits = [];
        let currentEditItem = null;

        // DOM Elements
        const uploadZone = document.getElementById('upload-zone');
        const fileInput = document.getElementById('file-input');
        const previewContainer = document.getElementById('preview-container');
        const pdfCanvas = document.getElementById('pdf-preview');
        const textLayer = document.getElementById('text-layer');
        const pageNav = document.getElementById('page-nav');
        const downloadBtn = document.getElementById('download-btn');
        const signaturePad = document.getElementById('signature-pad');
        const initialsPad = document.getElementById('initials-pad');
        const editModal = document.getElementById('edit-modal');
        const editInput = document.getElementById('edit-input');

        // Date formats
        const dateFormats = [
            { label: 'MM/DD/YYYY', format: () => new Date().toLocaleDateString('en-US') },
            { label: 'DD/MM/YYYY', format: () => new Date().toLocaleDateString('en-GB') },
            { label: 'YYYY-MM-DD', format: () => new Date().toISOString().split('T')[0] },
            { label: 'Month DD, YYYY', format: () => new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) },
            { label: 'DD Month YYYY', format: () => new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' }) },
            { label: 'MM/DD/YY', format: () => new Date().toLocaleDateString('en-US', { year: '2-digit', month: '2-digit', day: '2-digit' }) },
        ];

        // Initialize
        function init() {
            initDateFormats();
            initCheckboxStyles();
            initTabs();
            initSignaturePads();
            renderSignatures();
            renderInitials();
        }

        function initDateFormats() {
            const container = document.getElementById('date-formats');
            container.innerHTML = dateFormats.map((df, i) => `
                <div class="date-format-btn" data-index="${i}">${df.format()}</div>
            `).join('');

            container.querySelectorAll('.date-format-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    container.querySelectorAll('.date-format-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedDateFormat = parseInt(btn.dataset.index);
                    currentTool = 'date';
                    clearSelections();
                });
            });
        }

        function initCheckboxStyles() {
            document.querySelectorAll('.checkbox-style').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.checkbox-style').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedCheckboxStyle = btn.dataset.style;
                    currentTool = 'checkbox';
                    clearSelections();
                });
            });
        }

        function initTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
                });
            });
        }

        // Signature Pad Setup
        function initSignaturePads() {
            setupDrawingPad(signaturePad, document.getElementById('sig-pen-width'), document.getElementById('sig-pen-color'), 'sig');
            setupDrawingPad(initialsPad, null, null, 'initials');
        }

        function setupDrawingPad(canvas, penWidthEl, penColorEl, type) {
            const ctx = canvas.getContext('2d');
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;

            function resize() {
                const rect = canvas.parentElement.getBoundingClientRect();
                canvas.width = rect.width;
                canvas.height = type === 'initials' ? 80 : 120;
                ctx.strokeStyle = penColorEl ? penColorEl.value : '#000000';
                ctx.lineWidth = penWidthEl ? penWidthEl.value : 2;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
            }

            resize();
            window.addEventListener('resize', resize);

            if (penWidthEl) penWidthEl.addEventListener('input', () => ctx.lineWidth = penWidthEl.value);
            if (penColorEl) penColorEl.addEventListener('input', () => ctx.strokeStyle = penColorEl.value);

            function getCoords(e) {
                const rect = canvas.getBoundingClientRect();
                return [(e.clientX || e.touches?.[0]?.clientX) - rect.left, (e.clientY || e.touches?.[0]?.clientY) - rect.top];
            }

            function start(e) { isDrawing = true; [lastX, lastY] = getCoords(e); }
            function draw(e) {
                if (!isDrawing) return;
                e.preventDefault();
                const [x, y] = getCoords(e);
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                ctx.stroke();
                [lastX, lastY] = [x, y];
            }
            function stop() { isDrawing = false; }

            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stop);
            canvas.addEventListener('mouseout', stop);
            canvas.addEventListener('touchstart', start);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stop);

            // Clear/Save handlers
            if (type === 'sig') {
                document.getElementById('clear-sig').addEventListener('click', () => ctx.clearRect(0, 0, canvas.width, canvas.height));
                document.getElementById('save-sig').addEventListener('click', () => {
                    const data = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    if (!data.data.some((ch, i) => i % 4 === 3 && ch !== 0)) return alert('Please draw your signature first!');
                    signatures.push(canvas.toDataURL());
                    localStorage.setItem('compliTrstSignatures', JSON.stringify(signatures));
                    renderSignatures();
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                });
            } else {
                document.getElementById('clear-initials').addEventListener('click', () => ctx.clearRect(0, 0, canvas.width, canvas.height));
                document.getElementById('save-initials').addEventListener('click', () => {
                    const data = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    if (!data.data.some((ch, i) => i % 4 === 3 && ch !== 0)) return alert('Please draw your initials first!');
                    initials.push(canvas.toDataURL());
                    localStorage.setItem('compliTrstInitials', JSON.stringify(initials));
                    renderInitials();
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                });
            }
        }

        function clearSelections() {
            selectedSignature = null;
            selectedInitials = null;
            renderSignatures();
            renderInitials();
        }

        function renderSignatures() {
            const list = document.getElementById('signature-list');
            if (signatures.length === 0) {
                list.innerHTML = '<p class="empty-state">No signatures saved yet</p>';
                return;
            }
            list.innerHTML = signatures.map((sig, i) => `
                <div class="saved-sig ${selectedSignature === i ? 'selected' : ''}" data-index="${i}">
                    <img src="${sig}" alt="Sig ${i+1}">
                    <button class="delete-sig" data-index="${i}">√ó</button>
                </div>
            `).join('');

            list.querySelectorAll('.saved-sig').forEach(el => {
                el.addEventListener('click', e => {
                    if (e.target.classList.contains('delete-sig')) return;
                    const idx = parseInt(el.dataset.index);
                    selectedSignature = selectedSignature === idx ? null : idx;
                    selectedInitials = null;
                    currentTool = 'signature';
                    renderSignatures();
                    renderInitials();
                });
            });

            list.querySelectorAll('.delete-sig').forEach(el => {
                el.addEventListener('click', e => {
                    e.stopPropagation();
                    signatures.splice(parseInt(el.dataset.index), 1);
                    localStorage.setItem('compliTrstSignatures', JSON.stringify(signatures));
                    if (selectedSignature === parseInt(el.dataset.index)) selectedSignature = null;
                    renderSignatures();
                });
            });
        }

        function renderInitials() {
            const list = document.getElementById('initials-list');
            if (initials.length === 0) {
                list.innerHTML = '<p class="empty-state">No initials saved yet</p>';
                return;
            }
            list.innerHTML = initials.map((sig, i) => `
                <div class="saved-sig ${selectedInitials === i ? 'selected' : ''}" data-index="${i}">
                    <img src="${sig}" alt="Init ${i+1}">
                    <button class="delete-sig" data-index="${i}">√ó</button>
                </div>
            `).join('');

            list.querySelectorAll('.saved-sig').forEach(el => {
                el.addEventListener('click', e => {
                    if (e.target.classList.contains('delete-sig')) return;
                    const idx = parseInt(el.dataset.index);
                    selectedInitials = selectedInitials === idx ? null : idx;
                    selectedSignature = null;
                    currentTool = 'initials';
                    renderSignatures();
                    renderInitials();
                });
            });

            list.querySelectorAll('.delete-sig').forEach(el => {
                el.addEventListener('click', e => {
                    e.stopPropagation();
                    initials.splice(parseInt(el.dataset.index), 1);
                    localStorage.setItem('compliTrstInitials', JSON.stringify(initials));
                    if (selectedInitials === parseInt(el.dataset.index)) selectedInitials = null;
                    renderInitials();
                });
            });
        }

        // Text addition
        document.getElementById('add-text-btn').addEventListener('click', () => {
            const text = document.getElementById('text-input').value.trim();
            if (!text) return alert('Please enter some text!');
            if (!pdfDoc) return alert('Please upload a PDF first!');

            // Place in upper-left area of visible canvas
            const canvasWidth = pdfCanvas.width / scale;
            const canvasHeight = pdfCanvas.height / scale;
            placedElements.push({
                type: 'text',
                page: currentPage,
                x: 50,
                y: 100,
                data: text,
                font: document.getElementById('text-font').value,
                size: parseInt(document.getElementById('text-size').value),
                color: document.getElementById('text-color').value
            });
            document.getElementById('text-input').value = '';
            renderOverlays();
            updateCounts();
        });

        // Quick text
        document.querySelectorAll('.quick-tool[data-text]').forEach(btn => {
            btn.addEventListener('click', () => {
                if (!pdfDoc) return alert('Please upload a PDF first!');
                placedElements.push({
                    type: 'text',
                    page: currentPage,
                    x: 50,
                    y: 100,
                    data: btn.dataset.text,
                    font: document.getElementById('text-font').value,
                    size: parseInt(document.getElementById('text-size').value),
                    color: document.getElementById('text-color').value
                });
                renderOverlays();
                updateCounts();
            });
        });

        // Clear actions
        document.getElementById('clear-page-elements').addEventListener('click', () => {
            if (!pdfDoc) return;
            placedElements = placedElements.filter(el => el.page !== currentPage);
            renderOverlays();
            updateCounts();
        });

        document.getElementById('clear-all-elements').addEventListener('click', () => {
            if (!pdfDoc) return;
            if (confirm('Clear all elements from all pages?')) {
                placedElements = [];
                renderOverlays();
                updateCounts();
            }
        });

        // File Upload
        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('drag-over'); });
        uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
        uploadZone.addEventListener('drop', e => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            if (e.dataTransfer.files[0]?.type === 'application/pdf') loadPDF(e.dataTransfer.files[0]);
        });
        fileInput.addEventListener('change', e => { if (e.target.files[0]) loadPDF(e.target.files[0]); });

        async function loadPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            pdfBytes = new Uint8Array(arrayBuffer.slice(0));
            pdfDoc = await pdfjsLib.getDocument({ data: pdfBytes.slice(0) }).promise;
            totalPages = pdfDoc.numPages;
            currentPage = 1;
            placedElements = [];
            textEdits = [];
            textItems = [];

            document.getElementById('total-pages').textContent = totalPages;
            uploadZone.classList.add('has-file');
            uploadZone.innerHTML = `
                <div class="upload-icon">‚úÖ</div>
                <p class="file-name">${file.name}</p>
                <p style="margin-top:8px;font-size:0.85rem;">Click to change</p>
            `;
            previewContainer.style.display = 'flex';
            pageNav.style.display = 'flex';
            downloadBtn.disabled = false;
            renderPage();
            updateCounts();
        }

        async function renderPage() {
            const page = await pdfDoc.getPage(currentPage);
            const viewport = page.getViewport({ scale });
            pdfCanvas.width = viewport.width;
            pdfCanvas.height = viewport.height;
            await page.render({ canvasContext: pdfCanvas.getContext('2d'), viewport }).promise;

            document.getElementById('current-page').textContent = currentPage;
            document.getElementById('prev-page').disabled = currentPage <= 1;
            document.getElementById('next-page').disabled = currentPage >= totalPages;

            // Extract text for editing
            if (!textItems[currentPage]) {
                const textContent = await page.getTextContent();
                const containerRect = previewContainer.getBoundingClientRect();
                const canvasRect = pdfCanvas.getBoundingClientRect();
                const offsetX = canvasRect.left - containerRect.left;
                const offsetY = canvasRect.top - containerRect.top;

                textItems[currentPage] = textContent.items.map((item, index) => {
                    const tx = pdfjsLib.Util.transform(viewport.transform, item.transform);
                    return {
                        index,
                        str: item.str,
                        x: tx[4],
                        y: tx[5] - item.height * scale,
                        width: item.width * scale,
                        height: item.height * scale,
                        transform: item.transform,
                        offsetX,
                        offsetY
                    };
                });
            }

            renderOverlays();
            renderTextLayer();
        }

        function renderOverlays() {
            const overlayContainer = document.getElementById('overlay-container');
            overlayContainer.innerHTML = '';

            if (!pdfCanvas.width || placedElements.length === 0) return;

            // Wait for next frame to ensure canvas is laid out
            requestAnimationFrame(() => {
                // Position overlay container to match canvas exactly
                const containerRect = previewContainer.getBoundingClientRect();
                const canvasRect = pdfCanvas.getBoundingClientRect();
                
                overlayContainer.style.left = (canvasRect.left - containerRect.left) + 'px';
                overlayContainer.style.top = (canvasRect.top - containerRect.top) + 'px';
                overlayContainer.style.width = pdfCanvas.width + 'px';
                overlayContainer.style.height = pdfCanvas.height + 'px';

                placedElements.forEach((el, idx) => {
                    if (el.page !== currentPage) return;

                    const overlay = document.createElement('div');
                    overlay.className = 'element-overlay ' + el.type + '-el';
                    overlay.dataset.idx = idx;
                    overlay.style.position = 'absolute';
                    overlay.style.left = (el.x * scale) + 'px';
                    overlay.style.top = (el.y * scale) + 'px';

                    if (el.type === 'signature' || el.type === 'initials') {
                        overlay.innerHTML = `
                            <img src="${el.dataUrl}" style="width:${el.width * scale}px;" draggable="false">
                            <div class="element-controls"><button class="el-remove" data-index="${idx}">√ó</button></div>
                            <div class="resize-handle se" data-index="${idx}"></div>
                        `;
                    } else if (el.type === 'text' || el.type === 'date') {
                        overlay.style.fontSize = (el.size * scale) + 'px';
                        overlay.style.color = el.color;
                        overlay.style.fontFamily = el.font === 'Courier' ? 'monospace' : el.font === 'Times-Roman' ? 'serif' : 'sans-serif';
                        overlay.innerHTML = `<span class="el-text">${el.data}</span><div class="element-controls"><button class="el-remove" data-index="${idx}">√ó</button></div><div class="resize-handle se" data-index="${idx}" data-type="text"></div>`;
                    } else if (el.type === 'checkbox') {
                        overlay.style.fontSize = (el.size * scale) + 'px';
                        overlay.innerHTML = `${el.data}<div class="element-controls"><button class="el-remove" data-index="${idx}">√ó</button></div><div class="resize-handle se" data-index="${idx}" data-type="text"></div>`;
                    }

                    overlay.querySelector('.el-remove')?.addEventListener('click', e => {
                        e.stopPropagation();
                        placedElements.splice(idx, 1);
                        renderOverlays();
                        updateCounts();
                    });

                    // Resize handle
                    const resizeHandle = overlay.querySelector('.resize-handle');
                    if (resizeHandle) {
                        resizeHandle.addEventListener('mousedown', e => {
                            e.stopPropagation();
                            e.preventDefault();
                            const startX = e.clientX;
                            const startY = e.clientY;
                            const isText = resizeHandle.dataset.type === 'text';
                            
                            if (isText) {
                                const origSize = el.size;
                                const onResize = (ev) => {
                                    const delta = (ev.clientX - startX + ev.clientY - startY) / 2;
                                    el.size = Math.max(8, Math.min(72, origSize + delta / scale));
                                    overlay.style.fontSize = (el.size * scale) + 'px';
                                };
                                const stopResize = () => {
                                    document.removeEventListener('mousemove', onResize);
                                    document.removeEventListener('mouseup', stopResize);
                                };
                                document.addEventListener('mousemove', onResize);
                                document.addEventListener('mouseup', stopResize);
                            } else {
                                const origW = el.width;
                                const onResize = (ev) => {
                                    el.width = Math.max(50, origW + (ev.clientX - startX) / scale);
                                    el.height = el.width * 0.33;
                                    overlay.querySelector('img').style.width = (el.width * scale) + 'px';
                                };
                                const stopResize = () => {
                                    document.removeEventListener('mousemove', onResize);
                                    document.removeEventListener('mouseup', stopResize);
                                };
                                document.addEventListener('mousemove', onResize);
                                document.addEventListener('mouseup', stopResize);
                            }
                        });
                    }

                    overlayContainer.appendChild(overlay);
                });
            });
        }

        // Global drag handling
        let dragState = null;

        document.getElementById('overlay-container').addEventListener('mousedown', e => {
            const overlay = e.target.closest('.element-overlay');
            if (!overlay) return;
            if (e.target.classList.contains('el-remove') || e.target.classList.contains('resize-handle')) return;
            
            e.preventDefault();
            e.stopPropagation();
            
            const idx = parseInt(overlay.dataset.idx);
            const el = placedElements[idx];
            if (!el) return;

            dragState = {
                overlay,
                el,
                startX: e.clientX,
                startY: e.clientY,
                origLeft: parseFloat(overlay.style.left),
                origTop: parseFloat(overlay.style.top),
                maxX: pdfCanvas.width - overlay.offsetWidth,
                maxY: pdfCanvas.height - overlay.offsetHeight
            };
            
            overlay.style.zIndex = '100';
            overlay.style.opacity = '0.85';
        });

        document.addEventListener('mousemove', e => {
            if (!dragState) return;
            
            const dx = e.clientX - dragState.startX;
            const dy = e.clientY - dragState.startY;
            
            let newX = dragState.origLeft + dx;
            let newY = dragState.origTop + dy;
            
            // Constrain to canvas
            newX = Math.max(0, Math.min(newX, dragState.maxX));
            newY = Math.max(0, Math.min(newY, dragState.maxY));
            
            dragState.overlay.style.left = newX + 'px';
            dragState.overlay.style.top = newY + 'px';
            
            // Update element data
            dragState.el.x = newX / scale;
            dragState.el.y = newY / scale;
        });

        document.addEventListener('mouseup', () => {
            if (dragState) {
                dragState.overlay.style.zIndex = '';
                dragState.overlay.style.opacity = '';
                dragState = null;
            }
        });

        function renderTextLayer() {
            textLayer.innerHTML = '';
            if (!textItems[currentPage]) return;

            const containerRect = previewContainer.getBoundingClientRect();
            const canvasRect = pdfCanvas.getBoundingClientRect();
            const offsetX = canvasRect.left - containerRect.left;
            const offsetY = canvasRect.top - containerRect.top;

            textLayer.style.width = pdfCanvas.width + 'px';
            textLayer.style.height = pdfCanvas.height + 'px';
            textLayer.style.left = offsetX + 'px';
            textLayer.style.top = offsetY + 'px';

            textItems[currentPage].forEach((item, index) => {
                if (!item.str.trim()) return;

                const div = document.createElement('div');
                div.className = 'text-item';
                div.dataset.index = index;
                
                const edit = textEdits.find(e => e.page === currentPage && e.index === index);
                if (edit) {
                    div.classList.add('modified');
                    div.textContent = edit.newText;
                } else {
                    div.textContent = item.str;
                }

                div.style.left = item.x + 'px';
                div.style.top = item.y + 'px';
                div.style.fontSize = (item.height * 0.85) + 'px';
                div.style.height = item.height + 'px';
                div.style.lineHeight = item.height + 'px';
                div.style.minWidth = (item.width || 10) + 'px';

                div.addEventListener('click', () => openEditModal(item, index));
                textLayer.appendChild(div);
            });
        }

        function openEditModal(item, index) {
            currentEditItem = { item, index, page: currentPage };
            const existingEdit = textEdits.find(e => e.page === currentPage && e.index === index);
            editInput.value = existingEdit ? existingEdit.newText : item.str;
            document.getElementById('original-text').textContent = item.str;
            editModal.classList.add('active');
            editInput.focus();
            editInput.select();
        }

        document.getElementById('edit-cancel').addEventListener('click', () => {
            editModal.classList.remove('active');
            currentEditItem = null;
        });

        document.getElementById('edit-apply').addEventListener('click', applyTextEdit);
        editInput.addEventListener('keydown', e => {
            if (e.key === 'Enter') applyTextEdit();
            if (e.key === 'Escape') { editModal.classList.remove('active'); currentEditItem = null; }
        });

        function applyTextEdit() {
            if (!currentEditItem) return;
            const { item, index, page } = currentEditItem;
            const newText = editInput.value;

            textEdits = textEdits.filter(e => !(e.page === page && e.index === index));
            if (newText !== item.str) {
                textEdits.push({ page, index, original: item.str, newText, item });
            }

            editModal.classList.remove('active');
            currentEditItem = null;
            renderTextLayer();
            updateEditList();
            updateCounts();
        }

        function updateEditList() {
            const list = document.getElementById('edit-list');
            document.getElementById('edit-count').textContent = textEdits.length;

            if (textEdits.length === 0) {
                list.innerHTML = '<p class="empty-state">No text edits yet</p>';
                return;
            }

            list.innerHTML = textEdits.map((edit, i) => `
                <div class="edit-item">
                    <div class="edit-item-header">
                        <span class="edit-item-page">Page ${edit.page}</span>
                        <button class="edit-item-remove" data-index="${i}">√ó</button>
                    </div>
                    <div class="edit-item-original">${escapeHtml(edit.original)}</div>
                    <div class="edit-item-new">${escapeHtml(edit.newText)}</div>
                </div>
            `).join('');

            list.querySelectorAll('.edit-item-remove').forEach(btn => {
                btn.addEventListener('click', () => {
                    textEdits.splice(parseInt(btn.dataset.index), 1);
                    renderTextLayer();
                    updateEditList();
                    updateCounts();
                });
            });
        }

        function escapeHtml(str) {
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        // Find & Replace
        document.getElementById('replace-all-btn').addEventListener('click', async () => {
            const findText = document.getElementById('find-input').value;
            const replaceText = document.getElementById('replace-input').value;
            if (!findText) return alert('Please enter text to find');

            // Load all pages' text first
            for (let p = 1; p <= totalPages; p++) {
                if (!textItems[p]) {
                    const page = await pdfDoc.getPage(p);
                    const viewport = page.getViewport({ scale });
                    const textContent = await page.getTextContent();
                    textItems[p] = textContent.items.map((item, index) => ({
                        index, str: item.str, transform: item.transform, width: item.width, height: item.height
                    }));
                }
            }

            let count = 0;
            for (let page = 1; page <= totalPages; page++) {
                textItems[page].forEach((item, index) => {
                    if (item.str.includes(findText)) {
                        textEdits = textEdits.filter(e => !(e.page === page && e.index === index));
                        const newText = item.str.split(findText).join(replaceText);
                        if (newText !== item.str) {
                            textEdits.push({ page, index, original: item.str, newText, item });
                            count++;
                        }
                    }
                });
            }

            alert(count > 0 ? `Replaced ${count} occurrence(s)` : 'No matches found');
            renderTextLayer();
            updateEditList();
            updateCounts();
        });

        // Canvas click for placing sign elements
        pdfCanvas.addEventListener('click', e => {
            const rect = pdfCanvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) / scale;
            const y = (e.clientY - rect.top) / scale;

            if (currentTool === 'signature' && selectedSignature !== null) {
                placedElements.push({ type: 'signature', page: currentPage, x, y, width: 150, height: 50, dataUrl: signatures[selectedSignature] });
            } else if (currentTool === 'initials' && selectedInitials !== null) {
                placedElements.push({ type: 'initials', page: currentPage, x, y, width: 60, height: 40, dataUrl: initials[selectedInitials] });
            } else if (currentTool === 'date' && selectedDateFormat !== null) {
                placedElements.push({
                    type: 'date', page: currentPage, x, y,
                    data: dateFormats[selectedDateFormat].format(),
                    font: document.getElementById('date-font').value,
                    size: parseInt(document.getElementById('date-size').value),
                    color: document.getElementById('date-color').value
                });
            } else if (currentTool === 'checkbox') {
                placedElements.push({ type: 'checkbox', page: currentPage, x, y, data: selectedCheckboxStyle, size: 16, color: '#000000' });
            } else {
                return;
            }

            renderOverlays();
            updateCounts();
        });

        // Page navigation
        document.getElementById('prev-page').addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderPage(); } });
        document.getElementById('next-page').addEventListener('click', () => { if (currentPage < totalPages) { currentPage++; renderPage(); } });

        // Zoom
        document.getElementById('zoom-in').addEventListener('click', () => {
            scale = Math.min(scale + 0.25, 3);
            document.getElementById('zoom-level').textContent = Math.round(scale * 100) + '%';
            renderPage();
        });
        document.getElementById('zoom-out').addEventListener('click', () => {
            scale = Math.max(scale - 0.25, 0.5);
            document.getElementById('zoom-level').textContent = Math.round(scale * 100) + '%';
            renderPage();
        });

        function updateCounts() {
            const total = placedElements.length + textEdits.length;
            document.getElementById('element-count').textContent = total === 0 ? 'No changes yet' : `${total} change${total !== 1 ? 's' : ''}`;
        }

        // Download
        downloadBtn.addEventListener('click', async () => {
            if (!pdfBytes) return;
            if (placedElements.length === 0 && textEdits.length === 0) return alert('No changes to save');

            try {
                const { PDFDocument, rgb, StandardFonts } = PDFLib;
                const doc = await PDFDocument.load(pdfBytes.slice(0));
                const helvetica = await doc.embedFont(StandardFonts.Helvetica);
                const pages = doc.getPages();

                // Apply sign mode elements
                for (const el of placedElements) {
                    const page = pages[el.page - 1];
                    const { width, height } = page.getSize();

                    if (el.type === 'signature' || el.type === 'initials') {
                        const base64 = el.dataUrl.split(',')[1];
                        const imgBytes = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
                        const img = await doc.embedPng(imgBytes);
                        const dims = img.scale(el.width / img.width);
                        page.drawImage(img, { x: el.x, y: height - el.y - dims.height, width: dims.width, height: dims.height });
                    } else if (el.type === 'text' || el.type === 'date') {
                        const fontMap = { 'Helvetica': StandardFonts.Helvetica, 'Times-Roman': StandardFonts.TimesRoman, 'Courier': StandardFonts.Courier };
                        const font = await doc.embedFont(fontMap[el.font] || StandardFonts.Helvetica);
                        const hex = el.color.replace('#', '');
                        const r = parseInt(hex.substr(0, 2), 16) / 255;
                        const g = parseInt(hex.substr(2, 2), 16) / 255;
                        const b = parseInt(hex.substr(4, 2), 16) / 255;
                        page.drawText(el.data, { x: el.x, y: height - el.y - el.size, size: el.size, font, color: rgb(r, g, b) });
                    } else if (el.type === 'checkbox') {
                        const size = el.size;
                        const x = el.x;
                        const y = height - el.y - size;
                        
                        if (el.data === '‚úì') {
                            // Draw checkmark as lines
                            page.drawLine({ start: { x: x + 2, y: y + size/2 }, end: { x: x + size/3, y: y + 3 }, thickness: 2, color: rgb(0, 0, 0) });
                            page.drawLine({ start: { x: x + size/3, y: y + 3 }, end: { x: x + size - 2, y: y + size - 3 }, thickness: 2, color: rgb(0, 0, 0) });
                        } else if (el.data === '‚úó') {
                            // Draw X as lines
                            page.drawLine({ start: { x: x + 2, y: y + 2 }, end: { x: x + size - 2, y: y + size - 2 }, thickness: 2, color: rgb(0, 0, 0) });
                            page.drawLine({ start: { x: x + size - 2, y: y + 2 }, end: { x: x + 2, y: y + size - 2 }, thickness: 2, color: rgb(0, 0, 0) });
                        } else if (el.data === '‚óè') {
                            // Filled circle
                            page.drawCircle({ x: x + size/2, y: y + size/2, size: size/2 - 1, color: rgb(0, 0, 0) });
                        } else if (el.data === '‚òê') {
                            // Empty box
                            page.drawRectangle({ x, y, width: size, height: size, borderColor: rgb(0, 0, 0), borderWidth: 1.5 });
                        } else if (el.data === '‚òë') {
                            // Box with checkmark
                            page.drawRectangle({ x, y, width: size, height: size, borderColor: rgb(0, 0, 0), borderWidth: 1.5 });
                            page.drawLine({ start: { x: x + 3, y: y + size/2 }, end: { x: x + size/3, y: y + 3 }, thickness: 1.5, color: rgb(0, 0, 0) });
                            page.drawLine({ start: { x: x + size/3, y: y + 3 }, end: { x: x + size - 3, y: y + size - 3 }, thickness: 1.5, color: rgb(0, 0, 0) });
                        }
                    }
                }

                // Apply text edits
                for (const edit of textEdits) {
                    const page = pages[edit.page - 1];
                    const { height } = page.getSize();
                    const item = edit.item;
                    const x = item.transform[4];
                    const y = item.transform[5];
                    const fontSize = Math.abs(item.transform[3]) || 12;

                    // Cover original
                    const textWidth = helvetica.widthOfTextAtSize(edit.original, fontSize);
                    page.drawRectangle({ x: x - 1, y: y - 2, width: textWidth + 4, height: fontSize + 4, color: rgb(1, 1, 1) });

                    // Draw new
                    page.drawText(edit.newText, { x, y, size: fontSize, font: helvetica, color: rgb(0, 0, 0) });
                }

                const editedBytes = await doc.save();
                const blob = new Blob([editedBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'edited-document.pdf';
                a.click();
                URL.revokeObjectURL(url);

            } catch (err) {
                console.error(err);
                alert('Error saving PDF: ' + err.message);
            }
        });

        editModal.addEventListener('click', e => { if (e.target === editModal) { editModal.classList.remove('active'); currentEditItem = null; } });

        init();
    </script>
</body>
</html>
